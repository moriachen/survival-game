<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>æœ«æ—¥å›¤è´§ç”Ÿå­˜ Â· ç½‘é¡µç‰ˆï¼ˆå®Œæ•´ç‰ˆÂ·è‡ªå¸¦å® ç‰©ï¼‰</title>
<style>
    :root{
      --bg:#0b0f14; --panel:#10161c; --card:#131b23; --line:#232e3a; --text:#f5f7fa; --muted:#9fb0c2;
      --accent:#ff4d4f; --ok:#14e099; --warn:#ffcc4d; --vio:#6c5ce7;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e1420);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial;}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{font-size:28px;margin:8px 0 12px 0}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .tile{background:#0f1622;border:1px solid var(--line);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}
    .btn{background:#1f2937;color:#fff;border:1px solid #0000;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent)}
    .btn.good{background:var(--ok);color:#072}
    .btn.ghost{background:transparent;border:1px solid var(--line)}
    .btn.small{padding:6px 10px;border-radius:10px}
    .stat{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .kpi{min-width:160px;background:#0f1622;border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi .lab{font-size:12px;color:var(--muted)}
    .kpi .num{font-size:22px;font-weight:800}
    .bar{height:8px;background:#0d121a;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,#ff4d4f,#ff7a45)}
    .pill{padding:4px 10px;border-radius:999px;font-size:12px}
    .pill.ok{background:rgba(20,224,153,.18);color:var(--ok)}
    .pill.warn{background:rgba(255,204,77,.2);color:var(--warn)}
    .pill.bad{background:rgba(255,77,79,.2);color:#ff6b6b}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tab{padding:10px 14px;border:1px solid var(--line);border-radius:12px;cursor:pointer}
    .tab.active{background:var(--accent);border-color:transparent}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:10px 12px}
    tbody tr{background:#0f1622;border:1px solid var(--line)}
    tbody tr td:first-child{border-radius:10px 0 0 10px}
    tbody tr td:last-child{border-radius:0 10px 10px 0}
    input[type=number]{width:90px;background:#0d1620;border:1px solid var(--line);color:#fff;border-radius:10px;padding:8px}
    .right{text-align:right}

    .footer{opacity:.6;text-align:center;margin:18px 0 8px}
    .notice{border-left:4px solid var(--accent);padding-left:10px}
    dialog{border:none;border-radius:16px;background:#0f1622;color:#fff;padding:18px;max-width:420px}
    dialog::backdrop{background:rgba(0,0,0,.55)}
  button[disabled]{opacity:.55; cursor:not-allowed; filter:grayscale(0.2);} 

/* --- Mobile touch improvements --- */
button, .btn, .tab, .tile, [role="button"]{
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  cursor: pointer;
}

</style>
</head>
<body>
<div class="wrap">
<h1>ğŸ§Ÿâ€â™‚ï¸ æœ«æ—¥å›¤è´§ç”Ÿå­˜ Â· ç½‘é¡µç‰ˆï¼ˆå®Œæ•´ç‰ˆÂ·è‡ªå¸¦å® ç‰©ï¼‰</h1>
<div class="muted">å•æ–‡ä»¶ Â· æœ¬åœ°å­˜æ¡£ Â· è§„åˆ™é©±åŠ¨ï¼ˆæ— åç«¯ï¼‰</div>
<!-- é¡¶éƒ¨ KPI -->
<div class="stat" id="kpi">
<div class="kpi"><div class="lab">æ—¥æœŸ</div><div class="num" id="dayLab"></div><div class="muted" id="hourLab"></div></div>
<div class="kpi"><div class="lab">èµ„é‡‘ï¼ˆ$ï¼‰</div><div class="num" id="moneyLab"></div><div class="bar"><i id="moneyBar" style="width:50%"></i></div></div>
<div class="kpi"><div class="lab">ä½“åŠ›</div><div class="num" id="staLab"></div><div class="bar"><i id="staBar" style="width:80%"></i></div></div>
<div class="kpi"><div class="lab">ç²¾ç¥åº¦</div><div class="num" id="moodLab"></div><div class="muted">0 åˆ™å´©æºƒ</div></div>
<div class="kpi"><div class="lab">é¥±é£Ÿåº¦</div><div class="num" id="hungerLab"></div><div class="muted">0 åˆ™è¿›å…¥é¥¥é¥¿å€’è®¡æ—¶</div></div>
<div class="kpi"><div class="lab">ä»Šæ—¥å‰©ä½™å·¥æ—¶</div><div class="num" id="hoursLeftLab"></div><div class="muted">å…è®¸é€æ”¯ <input id="allowOver" type="checkbox"/></div></div>
<div class="kpi"><div class="lab">ä»“åº“å®¹é‡</div><div class="num" id="capLab"></div><div class="muted" id="capSub"></div></div>
<div class="kpi"><div class="lab">é£é™©/ç”µåŠ›</div><div class="num" id="riskLab"></div><div class="muted" id="powerLab"></div></div>
</div>
<!-- Tabs -->
<div class="tabs" id="tabs"></div>
<!-- Panels -->
<div id="panel"></div>
<div class="footer">Â© Survival Web Demo Â· å»ºè®®éƒ¨ç½² GitHub Pages</div>
</div>
<!-- å¼€å±€å® ç‰©é€‰æ‹© -->
<dialog id="petDlg">
<h3>é€‰æ‹©ä½ çš„å® ç‰©</h3>
<p class="muted">ä½ å°†è‡ªå¸¦ä¸€åªå® ç‰©ä½œä¸ºä¼™ä¼´ã€‚è¯·åœ¨çŒ«ä¸ç‹—ä¸­é€‰æ‹©å…¶ä¸€ã€‚åç»­éœ€è¦åœ¨è¶…å¸‚è´­ä¹°ç›¸åº”çš„å® ç‰©ç²®ã€‚</p>
<div class="row">
<button class="btn" id="chooseDog">ğŸ• é€‰æ‹©å°ç‹—</button>
<button class="btn" id="chooseCat">ğŸˆ é€‰æ‹©å°çŒ«</button>
</div>
</dialog>
<dialog id="popDlg">
<h3 id="popTitle">æç¤º</h3>
<div class="muted" id="popText" style="margin:8px 0 12px"></div>
<div class="row"><button class="btn" onclick="document.getElementById('popDlg').close()">å¥½çš„</button></div>
</dialog>
<script>
const LS_KEY = 'survival_web_v5_petfood';

// ======== ç‰©èµ„ä¸å•†åº—å®šä¹‰ï¼ˆç§»é™¤å® ç‰©åº—ï¼›åœ¨è¶…å¸‚åŠ å…¥çŒ«ç²®/ç‹—ç²®ä¸æè¿°ï¼‰ ========
const SHOPS = {
  costco: { name:'Costco é£Ÿå“/ç”Ÿæ´»', travelH:3, unloadH:2, items:[
    {id:'rice50', name:'å¤§ç±³ 50lb', price:35, unit:'è¢‹', slot:10, meals:240},
    {id:'pasta6', name:'æ„é¢ 6lb ç®±', price:10, unit:'ç®±', slot:3, meals:30},
    {id:'canned', name:'ç½å¤´ 12ç½', price:12, unit:'ç®±', slot:5, meals:24},
    {id:'bars', name:'èƒ½é‡æ£’ 30æ¡', price:18, unit:'ç›’', slot:3, meals:30},
    {id:'water24', name:'ç“¶è£…æ°´ 24Ã—500ml', price:4, unit:'ç®±', slot:2, waterL:12},
    {id:'oil5l', name:'é£Ÿç”¨æ²¹ 5L', price:12, unit:'æ¡¶', slot:3},
    {id:'milkpow', name:'å¥¶ç²‰ 2.5kg', price:25, unit:'ç½', slot:4, meals:25},
    {id:'eggs60', name:'é¸¡è›‹ 60æš', price:12, unit:'ç›’', slot:4, meals:20, needCold:true},
    {id:'cheese2k', name:'å¥¶é…ª 2kg', price:20, unit:'å—', slot:5, meals:20, needCold:true},
    {id:'dogfood', name:'ç‹—ç²®ï¼ˆ10å¤©ä»½ï¼‰', price:20, unit:'è¢‹', slot:4, petDays:{dog:10}},
    {id:'catfood', name:'çŒ«ç²®ï¼ˆ10å¤©ä»½ï¼‰', price:18, unit:'è¢‹', slot:4, petDays:{cat:10}}
  ]},
  walmart: { name:'Walmart ç»¼åˆè¶…å¸‚', travelH:3, unloadH:2, items:[
    {id:'flour25', name:'é¢ç²‰ 25lb', price:18, unit:'è¢‹', slot:5, meals:60},
    {id:'salt', name:'é£Ÿç› 50åŒ…', price:6, unit:'ç®±', slot:2},
    {id:'sugar', name:'ç™½ç³– 10lb', price:8, unit:'è¢‹', slot:3},
    {id:'freezer_meat', name:'å†·å†»è‚‰ 10lb', price:25, unit:'åŒ…', slot:6, meals:25, needCold:true},
    {id:'fishing_rod', name:'é’“é±¼ç«¿', price:20, unit:'æ ¹', slot:2},
    {id:'dogfood', name:'ç‹—ç²®ï¼ˆ10å¤©ä»½ï¼‰', price:22, unit:'è¢‹', slot:4, petDays:{dog:10}},
    {id:'catfood', name:'çŒ«ç²®ï¼ˆ10å¤©ä»½ï¼‰', price:20, unit:'è¢‹', slot:4, petDays:{cat:10}}
  ]},
  cvs: { name:'CVS è¯å“', travelH:3, unloadH:1, items:[
    {id:'pain', name:'æ­¢ç—›è¯', price:10, unit:'ç“¶', slot:1},
    {id:'vit', name:'ç»´ç”Ÿç´ ', price:15, unit:'ç“¶', slot:1},
    {id:'alcohol', name:'æ¶ˆæ¯’æ¶² 1L', price:8, unit:'ç“¶', slot:1},
    {id:'mask', name:'å£ç½© 50åª', price:20, unit:'ç›’', slot:2},
    {id:'cold', name:'æ„Ÿå†’è¯', price:12, unit:'ç›’', slot:1},
    {id:'antinflam', name:'æ¶ˆç‚è¯(OTC)', price:15, unit:'ç›’', slot:1}
  ]},
  homedepot: { name:'Home Depot è®¾å¤‡/å»ºæ', travelH:3, unloadH:2, items:[
    {id:'solar', name:'å¤ªé˜³èƒ½æ¿ 1kW', price:2000, unit:'å¥—', slot:30, build:'solar', buildH:2},
    {id:'battery', name:'å‚¨èƒ½ç”µæ± (UPS)', price:1000, unit:'å°', slot:20, build:'battery', buildH:0},
    {id:'gen', name:'å‘ç”µæœº(ä¸­å‹)', price:800, unit:'å°', slot:20, build:'gen', buildH:2},
    {id:'filter', name:'å®¶ç”¨å‡€æ°´æœº', price:200, unit:'å°', slot:10, build:'filter', buildH:3},
    {id:'rain', name:'é›¨æ°´æ”¶é›†æ¡¶ 50gal', price:250, unit:'åª', slot:20, build:'rain', buildH:2},
    {id:'freezer_ap', name:'ç«‹å¼å†°æŸœ', price:300, unit:'å°', slot:20, build:'freezer', buildH:1},
    {id:'toilet', name:'ä¾¿æºå•æ‰€/åŒ–å­¦å•æ‰€', price:120, unit:'å¥—', slot:8, build:'toilet', buildH:0},
    {id:'camp_stove', name:'ä¾¿æºç‚‰å…·(ä¸™çƒ·)', price:45, unit:'å¥—', slot:4},
    {id:'propane', name:'ä¸™çƒ·æ°”ç½ (10æ¬¡)', price:20, unit:'ç½', slot:3},
    {id:'board', name:'æœ¨æ¿', price:3, unit:'å—', slot:1, build:'board'},
    {id:'wire', name:'é“ä¸ç½‘å·', price:40, unit:'å·', slot:5, build:'wire'},
    {id:'tools', name:'å·¥å…·å¥—è£…', price:40, unit:'å¥—', slot:5}
  ]},
  bookstore: { name:'ä¹¦åº— æŠ€èƒ½ä¹¦ç±', travelH:2, unloadH:0, items:[
    {id:'book_garden', name:'ã€Šå®¶åº­å›­è‰ºå…¥é—¨ã€‹', price:25, unit:'æœ¬', slot:1},
    {id:'book_gen', name:'ã€Šå‘ç”µæœºç»´æŠ¤ã€‹', price:30, unit:'æœ¬', slot:1},
    {id:'book_firstaid', name:'ã€Šæ€¥æ•‘æ‰‹å†Œã€‹', price:30, unit:'æœ¬', slot:1},
    {id:'book_repair', name:'ã€Šå±…å®¶ä¿®è¡¥æŒ‡å—ã€‹', price:28, unit:'æœ¬', slot:1}
  ]},
  gas: { name:'åŠ æ²¹ç«™', travelH:2, unloadH:0, items:[
    {id:'jerrycan', name:'æ²¹æ¡¶(ç©º)', price:25, unit:'åª', slot:6},
    {id:'gas5', name:'æ±½æ²¹ 5galï¼ˆéœ€æ²¹æ¡¶ï¼‰', price:18, unit:'æ¡¶', slot:5}
  ]},
  market: { name:'å†œè´¸å¸‚åœº/ç§å­', travelH:2, unloadH:1, items:[
    {id:'seeds', name:'è”¬èœç§å­ç»„åˆ', price:20, unit:'å¥—', slot:1},
    {id:'fert', name:'æœ‰æœºè‚¥ 10lb', price:15, unit:'è¢‹', slot:3}
  ]},
  weapon: { name:'æˆ·å¤–/æ­¦å™¨åº—ï¼ˆè™šæ„ï¼‰', travelH:3, unloadH:1, items:[
    {id:'melee_bat', name:'é˜²èº«æ£’', price:25, unit:'æ ¹', slot:3},
    {id:'handgun', name:'æ‰‹æªï¼ˆéœ€åˆæ³•è®¸å¯ï¼‰', price:400, unit:'æŠŠ', slot:10},
    {id:'rifle', name:'æ­¥æªï¼ˆéœ€åˆæ³•è®¸å¯ï¼‰', price:800, unit:'æŠŠ', slot:15},
    {id:'ammo9', name:'9mm å¼¹è¯ Ã—50', price:30, unit:'ç›’', slot:2},
    {id:'ammo556', name:'5.56 å¼¹è¯ Ã—60', price:45, unit:'ç›’', slot:3},
    {id:'trap', name:'ç®€æ˜“é™·é˜±', price:35, unit:'åª', slot:3}
  ]}
};

// ç‰©èµ„è½¬åŒ–ï¼ˆè´­ä¹°å³æŠ˜ç®—ä¸ºæŠ½è±¡â€œé¤æ•°/é¥®æ°´â€ï¼‰
const ITEM_EFFECTS = {
  rice50:{ meals:240 }, pasta6:{meals:30}, canned:{meals:24}, bars:{meals:30}, milkpow:{meals:25},
  eggs60:{meals:20, perishable:true}, cheese2k:{meals:20, perishable:true},
  water24:{waterL:12}, freezer_meat:{meals:25, perishable:true}
};

// èœè°±ï¼ˆèŠ‚é€‰ï¼Œä¿ç•™å¯ç©åº¦ï¼‰
const RECIPES = [
  {id:'grill_fish', name:'çƒ¤é±¼', needAny:['fish_raw'], mealCost:0, mealsGain:2, mood:+10, energy:'cook', consume:['fish_raw']},
  {id:'fish_soup', name:'é±¼æ±¤', needAny:['fish_raw','salt'], mealCost:0, mealsGain:2, mood:+8, energy:'cook', consume:['fish_raw']},
  {id:'grill_venison', name:'çƒ¤é¹¿è‚‰', needAny:['venison_raw'], mealCost:0, mealsGain:3, mood:+12, energy:'cook', consume:['venison_raw']},
  {id:'rice_plain', name:'ç™½ç±³é¥­', needAny:['rice50'], mealCost:1, mood:+2, energy:'any'},
  {id:'soup_veg', name:'è”¬èœæ±¤', needAny:['seeds','canned'], mealCost:1, mood:+3, energy:'any'},
  {id:'fried_rice', name:'è›‹ç‚’é¥­', needAny:['rice50','eggs60','oil5l'], mealCost:2, mood:+8, energy:'cook'},
  {id:'pasta_red', name:'ç•ªèŒ„è‚‰é…±é¢', needAny:['pasta6','freezer_meat'], mealCost:2, mood:+12, energy:'cook'},
  {id:'stew_beef', name:'ç‚–ç‰›è‚‰', needAny:['freezer_meat'], mealCost:3, mood:+15, energy:'cook'},
  {id:'bbq_pork', name:'çº¢çƒ§è‚‰/çƒ¤è‚‰', needAny:['freezer_meat','sugar'], mealCost:3, mood:+15, energy:'cook'},
  {id:'coffee', name:'å’–å•¡', needAny:[], mealCost:0, mood:+10, energy:'any'},
  {id:'pizza', name:'ç”µçƒ¤æŠ«è¨', needAny:['flour25','cheese2k'], mealCost:3, mood:+30, energy:'power'},
  {id:'bbq_ribs', name:'çƒ¤æ’éª¨', needAny:['boar_raw'], mealCost:0, mealsGain:3, mood:+12, energy:'cook', consume:['boar_raw']},
  {id:'salad_simple', name:'ç®€æ˜“æ²™æ‹‰', needAny:['seeds'], mealCost:1, mood:+6, energy:'any'}
];

const WORLD_NEWS = [
  'å¤šåœ°æŠ¢è´­å‡çº§ï¼Œè­¦æ–¹å»ºè®®å‡å°‘å‡ºè¡Œã€‚',
  'ç”µç½‘è´Ÿè·æ¥è¿‘æé™ï¼Œæˆ–å°†åˆ†åŒºé™ç”µã€‚',
  'åŒ»é™¢æ€¥è¯Šçˆ†æ»¡ï¼Œå¸¸è§„è¯å“çŸ­ç¼ºã€‚',
  'åŠ æ²¹ç«™æ’é˜Ÿæ˜æ˜¾å¢åŠ ã€‚',
  'å±€éƒ¨éªšä¹±è§†é¢‘æµä¼ ï¼Œå»ºè®®é¿å¼€äººç¾¤ã€‚'
];

const EVENTS = [
  {id:'theft', minRisk:35, text:'å¤œé—´æœ‰å¯ç–‘äººå‘˜å¾˜å¾Šï¼ŒæŸå¤±å°‘é‡ç‰©èµ„ã€‚', effect:s=>{ const keys=Object.keys(s.inventory); if(keys.length){ const k=keys[Math.floor(Math.random()*keys.length)]; s.inventory[k]--; if(s.inventory[k]<=0) delete s.inventory[k]; s.usedSlots = Math.max(0, s.usedSlots-1); }}},
  {id:'car_issue', minRisk:25, text:'è½¦è¾†å°æ•…éšœï¼Œä¿®ç†èŠ±è´¹ $30ã€‚', effect:s=>{ s.money=Math.max(0,s.money-30); }},
  {id:'survivor', minRisk:10, text:'é‡åˆ°é™Œç”Ÿå¹¸å­˜è€…ï¼Œè¯·æ±‚å¸®åŠ©ã€‚', effect:s=>{ if(confirm('é‡åˆ°å¹¸å­˜è€…ï¼šæ˜¯å¦æ¥çº³ï¼Ÿ(ä¼šåŠ å…¥é˜Ÿä¼ï¼›å¯èƒ½è‡ªå¸¦æŠ€èƒ½ï¼Œä¹Ÿå¯èƒ½è¢«èƒŒåˆº)')){
      if(Math.random()<0.5){
        // åŠ å…¥åˆ°é˜Ÿä¼
        S.team.push({id:Date.now()+''+Math.floor(Math.random()*1000), name:'å¹¸å­˜è€…', type:'ally', typeZh:'æ³›ç”¨'});
        const roll=Math.random();
        if(roll<0.34){ s.skills.electrician=true; addLog('ä½ æ¥çº³äº†ç”µå·¥ï¼šå‘ç”µæœº/å¤ªé˜³èƒ½ç»´ä¿®æˆåŠŸç‡æé«˜ã€‚'); }
        else if(roll<0.67){ s.skills.pharmacist=true; addLog('ä½ æ¥çº³äº†è¯å¸ˆï¼šè¯å“ä½¿ç”¨æ•ˆç‡æå‡ã€‚'); }
        else { s.skills.guard=true; addLog('ä½ æ¥çº³äº†ä¿å®‰/å†›äººï¼šå¤œé—´è¢­å‡»é£é™© -5ã€‚'); s.risk=Math.max(0,s.risk-5); }
        s.mood=Math.min(100,s.mood+5);
      }else{
        addLog('å¹¸å­˜è€…èƒŒåˆºä½ ï¼ä¸¢å¤±è‹¥å¹²ç‰©èµ„ï¼Œç²¾ç¥åº¦ -10ã€‚'); s.mood=Math.max(0,s.mood-10);
        const keys=Object.keys(s.inventory); for(let i=0;i<2 && keys.length;i++){ const k=keys[Math.floor(Math.random()*keys.length)]; s.inventory[k]--; if(s.inventory[k]<=0) {delete s.inventory[k]; keys.splice(keys.indexOf(k),1);} }
        s.usedSlots=Math.max(0,s.usedSlots-3);
      }
    } else { addLog('ä½ æ‹’ç»äº†å¹¸å­˜è€…çš„åŠ å…¥ã€‚'); } }},
  {id:'zombie_evo', minRisk:0, text:'ä¸§å°¸è¿›åŒ–ï¼šé€Ÿåº¦/åŠ›é‡å¢å¼ºã€‚', effect:s=>{ s.risk=Math.min(100,s.risk+5); }}
];

// ======== åˆå§‹çŠ¶æ€ ========
function initState(){
  return {
    day:-3, hour:8, hoursLeft:12,
    money:10000, stamina:100, mood:100,
    hunger:100,
    starveDays:0,
    allowOver:false,
    baseType:null,
    storeCap:1000, usedSlots:0,
    solar:false, battery:false, gen:false, filter:false, rain:false, freezer:false, toilet:false,
    inventory:{}, meals:0, waterL:0,
    gasGal:0, propane:0,
    coldDays:0,
    risk:10, gridOn:true,
    pet:null, // 'dog' | 'cat'
    petFoodDays:{dog:0, cat:0},
    team:[],
    skills:{ electrician:false, pharmacist:false, guard:false },
    unlocks:{ grill_fish:false, grill_venison:false },
    garden:{plots:0, skill:false, progress:0},
    wep:{melee:false, handgun:false, rifle:false, ammo9:0, ammo556:0},
    news: 'åŸå¸‚æš‚æ—¶å¹³é™ï¼Œåªæœ‰å°‘æ•°äººå¯Ÿè§‰åˆ°å¼‚å¸¸ã€‚',
    log:[{t:ts(), msg:'ä½ æ˜¯è‹¦é€¼çš„ç¾å›½ç•™å­ã€‚é‡ç”Ÿè‡³æœ«æ—¥å‰ç¬¬3å¤©ï¼Œèˆªç­å°é”ï¼Œéœ€ç”¨ 1 ä¸‡ç¾å…ƒå®Œæˆé‡‡è´­ä¸å¸ƒç½®ã€‚'}]
  }
}

let S = JSON.parse(localStorage.getItem(LS_KEY)) || initState();

// ======== å·¥å…· ========
function save(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(S)); }catch(e){ /* ignore storage errors (iOS private mode, quota, etc.) */ } }
function ts(){ 
  const d = curDayAdj(); 
  const h = hourMod(); 
  return `Day ${d} ${h.toString().padStart(2,'0')}:00`; 
}
function fmt(n){ return (n||0).toLocaleString(); }
function addLog(msg){ S.log.unshift({t:ts(), msg}); if(S.log.length>120) S.log.pop(); }
function showMsg(title, text){ const d=document.getElementById('popDlg'); if(!d) return alert(text); document.getElementById('popTitle').textContent=title; document.getElementById('popText').textContent=text; d.showModal(); }
function hourMod(){ return ((S.hour%24)+24)%24; }
function curDayAdj(){ return S.day + Math.floor(S.hour/24); }
function powerAvailable(){ return S.gridOn || S.solar || S.gen || S.battery; }
function spendStamina(h){ const loss = Math.ceil(h*4); S.stamina = Math.max(0, S.stamina - loss); }
function needHours(h, riskDelta=0){
  if(S.hoursLeft>=h){ S.hoursLeft -= h; } else if(S.allowOver){ const deficit=h-S.hoursLeft; S.hoursLeft=0; addLog(`é€æ”¯ ${deficit} å°æ—¶ï¼Œå°†ä»ç¡çœ æ‰£é™¤ã€‚`);} else { alert('ä»Šå¤©å·¥æ—¶ä¸è¶³ï¼ˆå¯å‹¾é€‰å…è®¸é€æ”¯ï¼‰'); return false; }
  S.hour += h;
  // æ¯å°æ—¶é¥±é£Ÿåº¦ -10
  S.hunger = Math.max(0, S.hunger - 10*h);
  spendStamina(h); S.risk = Math.min(100, Math.max(0, S.risk + riskDelta + (S.pet==='dog'?1:0))); return true;
}

// ======== UI ========
const TABS = [
  {id:'dash', name:'ä»ªè¡¨ç›˜'},
  {id:'shop', name:'é‡‡è´­'},
  {id:'base', name:'åº‡æŠ¤æ‰€'},
  {id:'kitchen', name:'åšé¥­'},
  {id:'actions', name:'æ´»åŠ¨'},
  {id:'team', name:'åŒä¼´/å® ç‰©'},
  {id:'inv',  name:'ä»“åº“'}
];
let CUR='dash';

function render(){
  if(S.lockdown===undefined) S.lockdown=false;  // åˆå§‹åŒ–
  const indoorOnly = S.lockdown;                // ç»™æ‰€æœ‰é¢æ¿ç”¨
  document.getElementById('dayLab').textContent = `Day ${curDayAdj()}`;
  document.getElementById('hourLab').textContent = `å½“å‰æ—¶é—´ï¼š${hourMod().toString().padStart(2,'0')}:00`;
  document.getElementById('moneyLab').textContent = `$${fmt(S.money)}`;
  document.getElementById('staLab').textContent = `${S.stamina}/100`;
  document.getElementById('staBar').style.width = Math.max(0, S.stamina)+'%';
  document.getElementById('hoursLeftLab').textContent = `${S.hoursLeft}h`;
  document.getElementById('moneyBar').style.width = Math.min(100, (S.money/10000)*100)+'%';
  document.getElementById('allowOver').checked = S.allowOver;
  document.getElementById('allowOver').onchange = (e)=>{ S.allowOver = e.target.checked; save(); };
  document.getElementById('capLab').textContent = `${S.usedSlots}/${S.storeCap}`;
  document.getElementById('capSub').textContent = `å‰©ä½™ ${S.storeCap - S.usedSlots} æ ¼`;
  document.getElementById('riskLab').textContent = `é£é™© ${S.risk}/100`;
  document.getElementById('powerLab').textContent = powerAvailable()? 'ç”µåŠ›ï¼šå¯ç”¨' : 'ç”µåŠ›ï¼šä¸­æ–­';
  document.getElementById('moodLab').textContent = `${S.mood}/100`;
  document.getElementById('hungerLab').textContent = `${S.hunger}/100`;

  const tabs = document.getElementById('tabs'); tabs.innerHTML='';
  TABS.forEach(t=>{ const b=document.createElement('div'); b.className='tab'+(CUR===t.id?' active':''); b.textContent=t.name; b.onclick=()=>{ CUR=t.id; renderPanel(); }; tabs.appendChild(b); });
  renderPanel();

  enableMobilePressRoot();
  // åˆæ¬¡å¼€å±€ï¼šè¦æ±‚é€‰æ‹©å® ç‰©
  if(S.pet===null){ const d=document.getElementById('petDlg'); d.showModal(); document.getElementById('chooseDog').onclick=()=>{ S.pet='dog'; addLog('ä½ é€‰æ‹©äº†å°ç‹—ä½œä¸ºåŒä¼´ã€‚'); save(); d.close(); render(); }; document.getElementById('chooseCat').onclick=()=>{ S.pet='cat'; addLog('ä½ é€‰æ‹©äº†å°çŒ«ä½œä¸ºåŒä¼´ã€‚'); save(); d.close(); render(); }; }
}

function renderPanel(){
  const box = document.getElementById('panel');
  if(CUR==='dash') return renderDash(box);
  if(CUR==='shop') return renderShop(box);
  if(CUR==='base') return renderBase(box);
  if(CUR==='kitchen') return renderKitchen(box);
  if(CUR==='actions') return renderActions(box);
  if(CUR==='team') return renderTeam(box);
  if(CUR==='inv')  return renderInv(box);
}

function renderDash(box){
  const baseInfo = S.baseType? (S.baseType==='suburb'?'éƒŠå¤– houseï¼ˆè€•ç§/æ‰“çŒåŠ æˆï¼Œæ¯æ—¥ +1 é¤ï¼‰':'æ¹–è¾¹ houseï¼ˆå¯å–æ°´/é’“é±¼ï¼Œæ¯æ—¥ +2L æ°´ï¼‰') : 'æœªé€‰æ‹©åº‡æŠ¤æ‰€';
  const petInfo = S.pet? (S.pet==='dog'?`ğŸ• å°ç‹—ï¼šæ—¥å¸¸+7ç²¾ç¥ï¼ˆéœ€ç‹—ç²®ï¼‰ï¼Œå¶å°”æ‹›æƒ¹é£é™©ï¼›ç‹—ç²®å¤©æ•°ï¼š${S.petFoodDays.dog}`:`ğŸˆ å°çŒ«ï¼šæ—¥å¸¸+5ç²¾ç¥ï¼ˆéœ€çŒ«ç²®ï¼‰ï¼›çŒ«ç²®å¤©æ•°ï¼š${S.petFoodDays.cat}`) : 'æœªé€‰æ‹©';
  const teamInfo = S.team.length? S.team.map(x=>x.name).join('ã€') : 'æ— ';
  box.innerHTML = `
    <div class="grid">
      ${S.lockdown? '<div class="card"><div class="notice">ä»Šæ—¥å¤„äºå®¤å†…é¿é™©ï¼šä»…å¯ã€å­¦ä¹ /è®­ç»ƒã€‘ï¼›å…¶ä»–å®¤å¤–æ´»åŠ¨å°†è¢«é˜»æ­¢ã€‚</div></div>':''}
      <div class="card">
        <h3 style="color:${curDayAdj()>=0?'#ff6b6b':'#14e099'}">å¤–ç•Œå®å†µï¼ˆæ¯æ—¥åˆ·æ–°ï¼‰</h3>
        <div class="muted">${S.news}</div>
        <div class="row" style="margin-top:10px;gap:8px">
          <button class="btn ghost" onclick="advanceHour()">æ—¶é—´ +1h</button>
          <button class="btn primary" onclick="sleepNow()">ç¡è§‰ï¼ˆç»“ç®—å½“æ—¥ï¼‰</button>
          <button class="btn" onclick="resetGame()">é‡å¼€</button>
        </div>
        <div class="notice" style="margin-top:12px">æç¤ºï¼šå‡ºè¡Œä¼šæé«˜é£é™©ï¼›ä½“åŠ›éšå·¥æ—¶ä¸‹é™ï¼›ç²¾ç¥åº¦ä¸º 0 å°†ç›´æ¥å´©æºƒã€‚</div>
      </div>

      <div class="card">
        <h3>åº‡æŠ¤æ‰€ / é˜Ÿä¼</h3>
        <div>åº‡æŠ¤æ‰€ï¼š${baseInfo}</div>
        ${!S.baseType? `<div class="row" style="margin-top:10px">
          <button class="btn small" onclick="chooseBase('suburb')">é€‰æ‹©éƒŠå¤– Houseï¼ˆå®¹é‡ +100ï¼‰</button>
          <button class="btn small" onclick="chooseBase('lake')">é€‰æ‹©æ¹–è¾¹ Houseï¼ˆæ¯æ—¥ +2L æ°´ï¼‰</button>
        </div>`:''}
        <div style="margin-top:8px">å® ç‰©ï¼š${petInfo}</div>
        <div>åŒä¼´ï¼š${teamInfo}</div>
        <h3 style="margin-top:12px">ä»Šæ—¥æ—¥å¿—</h3><div class="muted">ï¼ˆå›´æ å—æŸæ—¶è¯·åˆ°ã€Œåº‡æŠ¤æ‰€ > ä¿®è¡¥ç»´æŠ¤ã€ä¿®è¡¥é“ä¸ç½‘ï¼‰</div>
        <div id="log"></div>
      </div>
    </div>
  `;
  const log = document.getElementById('log');
  log.innerHTML = S.log.map(e=>`<div class="tile"><b>${e.t}</b> â€” ${e.msg}</div>`).join('');
}

function chooseBase(t){ if(S.baseType) return; S.baseType=t; if(t==='suburb'){ S.storeCap+=100; addLog('é€‰æ‹©éƒŠå¤– houseï¼šä»“åº“å®¹é‡ +100ã€‚'); } if(t==='lake'){ addLog('é€‰æ‹©æ¹–è¾¹ houseï¼šæ¯æ—¥é¢å¤– +2L æ°´ã€‚'); } checkOutdoorAttack('æœå¯»'); save(); render(); }
function advanceHour(){ if(!needHours(1)) return; save(); render(); }

// ======== é‡‡è´­ ========
const CAR_CAP = 120;
function renderShop(box){
  if(curDayAdj()>=0){
    box.innerHTML = `<div class="card"><h3>ğŸ›’ é‡‡è´­</h3><div class="notice">æœ«æ—¥å·²å¼€å§‹ï¼ˆDay >= 0ï¼‰ï¼Œé‡‡è´­æ¸ é“å…³é—­ã€‚</div></div>`;
    return;
  }

  let shopId = 'costco';
  box.innerHTML = `
    <div class="card">
      <div class="row"><h3>ğŸ›’ é€‰æ‹©å•†åº—</h3>
        <select id="shopSel"></select>
        <button class="btn ghost small" id="goBtn">å‡ºå‘</button>
      </div>
      <div class="muted">è½¦è¾†å®¹é‡ï¼šæ¯è¶Ÿ ${CAR_CAP} æ ¼ï¼›è‹¥è¶…å‡ºå°†è‡ªåŠ¨å¤šè¶Ÿå¾€è¿”ï¼ˆå«å¸è´§æ—¶é—´ï¼‰ã€‚</div>
    </div>
    <div class="card" id="shopPanel" style="display:none"></div>
  `;
  const sel = document.getElementById('shopSel'); sel.innerHTML = Object.entries(SHOPS).map(([k,v])=>`<option value="${k}">${v.name}</option>`).join(''); sel.onchange=()=>{ shopId=sel.value };
  document.getElementById('goBtn').onclick = ()=>{
    const shop = SHOPS[shopId]; if(!needHours(shop.travelH, +5)) return; addLog(`å‰å¾€ ${shop.name}ï¼ˆ${shop.travelH}hï¼‰`); renderShopInner(shopId);
  };
}

function renderShopInner(shopId){
  const wrap = document.getElementById('shopPanel'); wrap.style.display='block'; const shop = SHOPS[shopId];
  const rows = shop.items.map(it=>`<tr><td>${it.name}<div class=\"muted\">$${it.price}/${it.unit} Â· å æ ¼ ${it.slot}${it.needCold?' Â· éœ€å†·è—':''}</div></td><td class=\"right\"><input type=\"number\" min=\"0\" value=\"0\" data-id=\"${it.id}\" class=\"qty\"></td></tr>`).join('');
  wrap.innerHTML = `
    <h3>${shop.name}</h3>
    <table><tbody>${rows}</tbody></table>
    <div class="row" style="justify-content:space-between">
      <div>æœ¬æ¬¡é¢„è®¡ï¼š<span id="est"></span></div>
      <div class="row"><button class="btn ghost small" id="calcBtn">é‡æ–°ä¼°ç®—</button><button class="btn primary" id="buyBtn">ç»“ç®—å¹¶è¿”å›ï¼ˆå«å¸è´§ï¼‰</button></div>
    </div>`;

  const collectQty = ()=>{ const o={}; wrap.querySelectorAll('.qty').forEach(i=>{ o[i.dataset.id]=Number(i.value||0); }); return o; };
  const est = ()=>{
    const qtys = collectQty(); let price=0, slots=0, meals=0, water=0, cold=0, petDaysDog=0, petDaysCat=0;
    shop.items.forEach(it=>{ const q=qtys[it.id]||0; price+=q*it.price; slots+=q*it.slot; const eff=ITEM_EFFECTS[it.id]||{}; meals+=(eff.meals||0)*q; water+=(eff.waterL||0)*q; if(it.needCold) cold+=q; if(it.petDays){ petDaysDog += (it.petDays.dog||0)*q; petDaysCat += (it.petDays.cat||0)*q; }
    });
    const trips = Math.max(1, Math.ceil(slots/CAR_CAP));
    let extraH = (trips-1)*(shop.travelH+shop.unloadH); if(slots>CAR_CAP) extraH += 1;
    document.getElementById('est').textContent = `èŠ±è´¹ $${fmt(price)} Â· å æ ¼ ${slots}ï¼ˆ${trips} è¶Ÿï¼‰ Â· é¢å¤– +${extraH}h Â· é¤æ•° +${meals} Â· æ°´ +${water}L Â· å†·é“¾ä»¶æ•° ${cold} Â· ç‹—ç²®å¤©æ•° +${petDaysDog} Â· çŒ«ç²®å¤©æ•° +${petDaysCat}`;
    return {price, slots, meals, water, extraH, trips, cold, qtys, petDaysDog, petDaysCat};
  };
  document.getElementById('calcBtn').onclick = est;
  document.getElementById('buyBtn').onclick = ()=>{
    const r = est(); const needH = r.extraH + shop.unloadH; if(S.money<r.price) return alert('èµ„é‡‘ä¸è¶³'); if(S.usedSlots + r.slots > S.storeCap) return alert('ä»“åº“å®¹é‡ä¸è¶³');
    if(r.qtys.gas5>0 && !(r.qtys.jerrycan>0 || (S.inventory.jerrycan||0)>0)) return alert('è´­ä¹°æ±½æ²¹éœ€è¦æ²¹æ¡¶(jerrycan)ã€‚');
    if(!needHours(needH, +5)) return;

    S.money -= r.price; S.usedSlots += r.slots; S.meals += r.meals; S.waterL += r.water; S.coldDays += r.cold>0? 2:0;

    // å†™åº“å­˜/å¼¹è¯/ç‡ƒæ–™
    Object.entries(r.qtys).forEach(([id,q])=>{ if(!q) return; S.inventory[id]=(S.inventory[id]||0)+q; if(id==='melee_bat') S.wep.melee=true; if(id==='handgun') S.wep.handgun=true; if(id==='rifle') S.wep.rifle=true; if(id==='ammo9') S.wep.ammo9+=q*50; if(id==='ammo556') S.wep.ammo556+=q*60; if(id==='gas5') S.gasGal += q*5; if(id==='propane') S.propane += q*10; });

    // å® ç‰©ç²®æ¢ç®—ä¸ºâ€œå¤©æ•°æ± â€
    S.petFoodDays.dog += r.petDaysDog;
    S.petFoodDays.cat += r.petDaysCat;

    addLog(`åœ¨ ${shop.name} é‡‡è´­ï¼š$${fmt(r.price)}ï¼Œå æ ¼ +${r.slots}ï¼ˆ${r.trips} è¶Ÿï¼‰ï¼Œé¤æ•° +${r.meals}ï¼Œæ°´ +${r.water}Lï¼Œç‹—ç²®å¤©æ•° +${r.petDaysDog}ï¼ŒçŒ«ç²®å¤©æ•° +${r.petDaysCat}ã€‚`);
    save(); CUR='dash'; render();
  };
  est();
}

// ======== åº‡æŠ¤æ‰€ï¼ˆè®¾å¤‡å®‰è£…/åŠ å›º/å•æ‰€ï¼‰ ========
function renderBase(box){
  box.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>ğŸ  å®‰è£…/åŠ å›º</h3>
        <div class="col">
          ${buildRow('å¤ªé˜³èƒ½(2h)','solar','solar',2)}
          ${buildRow('å‚¨èƒ½ç”µæ± (0h)','battery','battery',0)}
          ${buildRow('å‘ç”µæœº(2h)','gen','gen',2)}
          ${buildRow('å‡€æ°´æœº(3h)','filter','filter',3)}
          ${buildRow('é›¨æ°´æ¡¶(2h)','rain','rain',2)}
          ${buildRow('ç«‹å¼å†°æŸœ(1h)','freezer','freezer_ap',1)}
          ${buildRow('ä¾¿æºå•æ‰€(0h)','toilet','toilet',0)}
          ${consRow('å°çª— æœ¨æ¿ 1h/å—','board',1)}
          ${consRow('å›´æ  é“ä¸ç½‘ 2h/å·','wire',2)}
        </div>
      </div>

      <div class="card">
        <h3>å½“å‰çŠ¶æ€</h3>
        <div>åº‡æŠ¤æ‰€ï¼š${S.baseType? (S.baseType==='suburb'?'éƒŠå¤– house':'æ¹–è¾¹ house') : 'æœªé€‰æ‹©'}</div>
        <div>ç”µåŠ›ï¼š${powerAvailable()? '<span class=pill ok>å¯ç”¨</span>':'<span class=pill bad>ä¸­æ–­</span>'}</div>
        <div>å†·é“¾ç¼“å†²ï¼š${S.coldDays} å¤©</div>
        <div>è®¾å¤‡ï¼šå¤ªé˜³èƒ½ ${tick(S.solar)} / ç”µæ±  ${tick(S.battery)} / å‘ç”µæœº ${tick(S.gen)} / å‡€æ°´ ${tick(S.filter)} / é›¨æ°´ ${tick(S.rain)} / å†°æŸœ ${tick(S.freezer)} / å•æ‰€ ${tick(S.toilet)}</div>
        <div>æœ¨æ¿ï¼š${S.inventory.board||0} å— Â· å·²å° ${S.boards||0} å—</div>
        <div>é“ä¸ç½‘ï¼š${S.inventory.wire||0} å· Â· å·²å¸ƒç½® ${S.wires||0} å·</div>
      </div>
      <div class="card">
        <h3>ä¿®è¡¥ç»´æŠ¤</h3>
        <div class="muted">è‹¥å›´æ å—æŸï¼Œå°½å¿«ä¿®è¡¥ä»¥é™ä½è¢«è¢­é£é™©ã€‚é˜…è¯»ã€Šå±…å®¶ä¿®è¡¥æŒ‡å—ã€‹å¯æé«˜æˆåŠŸç‡ã€‚</div>
        ${S.wireBroken? `<button class=\"btn small\" onclick=\"repairFence()\">ä¿®è¡¥é“ä¸ç½‘ 2h</button>` : '<div class=\"pill ok\">å›´æ å®Œå¥½</div>'}
      </div>
    </div>
  `;
}
function tick(b){return b?'âœ”ï¸':'â€”'}
function buildRow(label, key, needItem, h){ const has=S[key]; const own=(S.inventory[needItem]||0)>0; const btn=has? '<span class="pill ok">å·²å®Œæˆ</span>' : (own? `<button class=\"btn small\" onclick=\"doBuild('${key}',${h},'${needItem}')\">å®‰è£…ï¼ˆ${h}hï¼‰</button>`: '<span class="pill bad">ç¼ºå°‘ææ–™</span>'); return `<div class=\"tile row\" style=\"justify-content:space-between\"><div>${label}</div><div>${btn}</div></div>`; }
function consRow(label, itemId, h){ const own=S.inventory[itemId]||0; const btn=own>0? `<button class=\"btn small\" onclick=\"consumeItem('${itemId}',${h})\">ä½¿ç”¨ 1ï¼ˆ${h}hï¼‰</button>`:'<span class=\"pill bad\">åº“å­˜ä¸è¶³</span>'; return `<div class=\"tile row\" style=\"justify-content:space-between\"><div>${label}</div><div>${btn}</div></div>`; }
function doBuild(key,h,itemId){ if(!needHours(h)) return; S.inventory[itemId]--; if(S.inventory[itemId]<=0) delete S.inventory[itemId]; S.usedSlots -= shopItemSlot(itemId); S[key]=true; if(key==='freezer') S.coldDays=5; addLog(`å®Œæˆï¼š${key} å®‰è£…ï¼ˆ${h}hï¼‰`); save(); render(); }
function consumeItem(itemId,h){ if(!needHours(h)) return; S.inventory[itemId]--; if(S.inventory[itemId]<=0) delete S.inventory[itemId]; S.usedSlots -= shopItemSlot(itemId); if(itemId==='board') S.boards=(S.boards||0)+1; if(itemId==='wire') S.wires=(S.wires||0)+1; addLog(`ä½¿ç”¨ ${itemId} 1 ä¸ªï¼ˆ${h}hï¼‰`); save(); render(); }
function shopItemSlot(id){ for(const k in SHOPS){ const f=SHOPS[k].items.find(x=>x.id===id); if(f) return f.slot; } return 0; }

// ======== åšé¥­ç³»ç»Ÿï¼ˆç”µåŠ›ä¼˜å…ˆï¼›å¦åˆ™æ¶ˆè€—ä¸™çƒ·æˆ–æ±½æ²¹ï¼‰ ========
function renderKitchen(box){
  const rows = RECIPES.filter(r=>{
    // é”ï¼šå¦‚æœè®¾ç½®äº† unlocks é¡¹ï¼Œéœ€å·²è§£é”æˆ–å·²æœ‰å¯¹åº”é£Ÿæ
    if(r.id==='grill_fish' && !S.unlocks.grill_fish && !(S.inventory.fish_raw>0)) return false;
    if(r.id==='grill_venison' && !S.unlocks.grill_venison && !(S.inventory.venison_raw>0)) return false;
    return true;
  }).map(r=>{
    const hasNeed = r.needAny.length===0 || r.needAny.some(id=> (S.inventory[id]||0)>0 );
    const energy = r.energy==='power'? 'éœ€è¦ç”µåŠ›' : (r.energy==='cook'? 'éœ€è¦ç”µ/ç‡ƒæ–™' : 'å¯ç”¨ç”µ/ç‡ƒæ–™');
    const costText = (r.mealCost>0? `æ¶ˆè€—é¤æ•° ${r.mealCost}`:'') + (r.consume? (r.mealCost>0?' Â· ':'') + `é£Ÿæ ${r.consume.join('ã€')} Ã—1` : '');
    const gainText = r.mealsGain? ` Â· åˆ¶ä½œå¾—é¤æ•° +${r.mealsGain}`:'';
    const btn = hasNeed? `<button class=\"btn small\" onclick=\"cook('${r.id}')\">çƒ¹é¥ª</button>` : '<span class=\"pill bad\">ç¼ºå°‘é£Ÿæ</span>';
    return `<tr><td>${r.name}<div class=\"muted\">${energy} Â· ${costText}${gainText} Â· ç²¾ç¥ +${r.mood}</div></td><td class=\"right\">${btn}</td></tr>`;
  }).join('');
  box.innerHTML = `
    <div class=\"grid\">
      <div class=\"card\">
        <h3>ğŸ³ å¨æˆ¿</h3>
        <div class=\"muted\">ä¼˜å…ˆä½¿ç”¨ç”µåŠ›çƒ¹é¥ªï¼›è‹¥æ— ç”µåŠ›ï¼Œå¯ç”¨ä¸™çƒ·ç½/å‘ç”µæœºæ±½æ²¹ã€‚å®¤å¤–æ˜ç«è¢«ç¦æ­¢ï¼ˆè¿‡é«˜é£é™©ï¼‰ã€‚</div>
        <div class=\"row\" style=\"margin:10px 0\"><div class=\"pill\">é¤æ•°ï¼š${S.meals}</div><div class=\"pill\">é¥®æ°´ï¼š${S.waterL}L</div><div class=\"pill\">ä¸™çƒ·ï¼š${S.propane}</div><div class=\"pill\">æ±½æ²¹ï¼š${S.gasGal.toFixed(1)} gal</div></div>
        <table><tbody>${rows}</tbody></table>
      </div>
      <div class=\"card\">
        <h3>æç¤º</h3>
        <div class=\"notice\">è‹¥æ— ç”µ/ç‡ƒæ–™ï¼Œåªèƒ½åƒç”Ÿé£Ÿï¼Œç²¾ç¥ -10ï¼Œå¹¶æå‡æ„ŸæŸ“é£é™©ã€‚</div>
      </div>
    </div>
  `;
}


// â€”â€” é¥±é£Ÿåº¦è§„åˆ™ï¼šè‚‰ç±»/ä¸»é£Ÿ +40ï¼›æœå­ +10ï¼›å…¶ä»–é»˜è®¤ +20 â€”â€”
const MEAT_IDS = ['freezer_meat','venison_raw','boar_raw','fish_raw'];
const STAPLE_IDS = ['rice50','pasta6','flour25'];
const FRUIT_IDS = ['wild_berry'];
function recipeSatGain(r){
  const needs = (r.needAny||[]).concat(r.consume||[]);
  const hasMeat = needs.some(id => MEAT_IDS.includes(id));
  const hasStaple = needs.some(id => STAPLE_IDS.includes(id));
  const hasFruit = needs.some(id => FRUIT_IDS.includes(id));
  if(hasMeat || hasStaple) return 40;
  if(hasFruit) return 10;
  return 20;
}

function cook(id){
  const r = RECIPES.find(x=>x.id===id); if(!r) return; if(S.meals < r.mealCost) return alert('é¤æ•°ä¸è¶³');
  let usedFuel = false;
  if(r.energy==='power'){ if(!powerAvailable()) return alert('éœ€è¦ç”µåŠ›'); }
  else if(r.energy==='cook'){
    if(!powerAvailable()){
      if(S.propane>0){ S.propane--; usedFuel=true; }
      else if(S.gasGal>=0.5){ S.gasGal-=0.5; usedFuel=true; }
      else return alert('éœ€è¦ä¸™çƒ·æˆ–æ±½æ²¹');
    }
  }
  S.meals -= r.mealCost; 
  let moodGain=r.mood;
  if(S.team.find(t=>t.type==='chef')) moodGain = Math.round(moodGain*1.1);
  S.mood = Math.min(100, S.mood + moodGain);

  // åƒé¥­æ¢å¤ä½“åŠ›
  let staGain = 10;
  S.stamina = Math.min(100, S.stamina + staGain);

  // åšé¥­ä¹Ÿä¼šæå‡é¥±é£Ÿåº¦ï¼ˆæŒ‰èœè°±ç±»åˆ«ï¼‰
  let satGain = recipeSatGain(r);
  S.hunger = Math.min(100, S.hunger + satGain);

  addLog(`çƒ¹é¥ªå®Œæˆï¼š${r.name}ï¼ˆç²¾ç¥ +${moodGain} Â· ä½“åŠ› +${staGain} Â· é¥±é£Ÿåº¦ +${satGain}${usedFuel?' Â· æ¶ˆè€—ç‡ƒæ–™':''}ï¼‰`);
  save(); render();
}



// ======== å®¤å¤–é£é™©ä¸å°é” ========

function checkOutdoorAttack(ctx='å®¤å¤–è¡ŒåŠ¨'){
  // Day < 0 ä¸è§¦å‘
  if(curDayAdj() < 0) return;

  if(Math.random() < 0.5){
    if(S.wep.handgun||S.wep.rifle||S.wep.melee){
      addLog(ctx+'æ—¶é­é‡è¢­å‡»ï¼Œä½†ä½ æˆåŠŸæŠµå¾¡ã€‚é£é™© -3');
      S.risk = Math.max(0, S.risk - 3);
      showMsg('é­é‡è¢­å‡»', 'ä½ è¢«ä¸§å°¸/åŠ«åŒªå›´ä¸Šï¼Œä½†å‡­å€Ÿè£…å¤‡æˆåŠŸå‡»é€€ã€‚');
    }else{
      addLog(ctx+'æ—¶é­é‡è¢­å‡»ï¼šä½“åŠ› -10 Â· å¿ƒæƒ… -8 Â· é£é™© +10');
      S.stamina = Math.max(0, S.stamina - 10);
      S.mood = Math.max(0, S.mood - 8);
      S.risk = Math.min(100, S.risk + 10);
      showMsg('é­é‡è¢­å‡»', 'ä½ åœ¨å®¤å¤–é­åˆ°æ”»å‡»ï¼Œå—äº†ä¼¤åªå¾—æ’¤é€€ã€‚');
    }
  }
}


function guardIndoorOnly(){
  if(S.lockdown){ alert('ä»Šæ—¥å¤„äºå®¤å†…é¿é™©ï¼Œä»…å…è®¸å­¦ä¹ /è®­ç»ƒç­‰å®¤å†…æ´»åŠ¨ã€‚'); return true; }
  return false;
}

// ======== æ´»åŠ¨ ========

function renderActions(box){
  const indoorOnly = S.lockdown===true;
  box.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>ğŸ£ é’“é±¼ï¼ˆæ¹–è¾¹ï¼‰</h3>
        <div class="muted">éœ€è¦ï¼šæ¹–è¾¹ house + é’“é±¼ç«¿ï¼›2h â‰ˆ 1~3 é¤ï¼Œå°‘é‡æå‡å¿ƒæƒ…ã€‚</div>
        <button class="btn small" onclick="goFish()">é’“é±¼ 2h</button>
      </div>
      <div class="card">
        <h3>ğŸŒ± ç§ç”°</h3>
        <div>åœ°å—ï¼š${S.garden.plots} Â· è¿›åº¦ï¼š${S.garden.progress}% Â· æŠ€èƒ½ï¼š${S.garden.skill?'å·²å­¦':'æœªå­¦'}</div>
        <div class="row"><button class="btn small" onclick="setupGarden()">å¼€å¦åœ°å—(2h)</button><button class="btn small" onclick="tendGarden()">ç…§æ–™æµ‡çŒ(2h)</button><button class="btn small" onclick="harvest()">æ”¶è·</button></div>
      </div>
      
<div class="card">
  <h3>ğŸ“š å­¦ä¹ </h3>
  <div class="muted">æ¯å­¦ä¹  2 å°æ—¶ï¼šæŠ€èƒ½æŒæ¡ +10%ï¼Œç›¸å…³è¡ŒåŠ¨æˆåŠŸç‡ +20%ã€‚éœ€æŒæœ‰å¯¹åº”ä¹¦ç±ã€‚</div>
  <div class="row" style="gap:8px;margin-top:8px">
    <button class="btn small" onclick="study('book_garden')" ${ (S.mastery?.garden||0) >= 100 ? 'disabled' : '' }>
      ã€Šå®¶åº­å›­è‰ºå…¥é—¨ã€‹2h Â· æŒæ¡ ${ (S.mastery?.garden||0) }%${ (S.mastery?.garden||0) >= 100 ? ' Â· å·²æ»¡çº§' : '' }
    </button>
    <button class="btn small" onclick="study('book_gen')" ${ (S.mastery?.generator||0) >= 100 ? 'disabled' : '' }>
      ã€Šå‘ç”µæœºç»´æŠ¤ã€‹2h Â· æŒæ¡ ${ (S.mastery?.generator||0) }%${ (S.mastery?.generator||0) >= 100 ? ' Â· å·²æ»¡çº§' : '' }
    </button>
    <button class="btn small" onclick="study('book_firstaid')" ${ (S.mastery?.firstaid||0) >= 100 ? 'disabled' : '' }>
      ã€Šæ€¥æ•‘æ‰‹å†Œã€‹2h Â· æŒæ¡ ${ (S.mastery?.firstaid||0) }%${ (S.mastery?.firstaid||0) >= 100 ? ' Â· å·²æ»¡çº§' : '' }
    </button>
    <button class="btn small" onclick="study('book_repair')" ${ (S.mastery?.repair||0) >= 100 ? 'disabled' : '' }>
      ã€Šå±…å®¶ä¿®è¡¥æŒ‡å—ã€‹2h Â· æŒæ¡ ${ (S.mastery?.repair||0) }%${ (S.mastery?.repair||0) >= 100 ? ' Â· å·²æ»¡çº§' : '' }
    </button>
  </div>
</div>

      </div>
      <div class="card">
        <h3>ğŸ›¡ï¸ è®­ç»ƒï¼ˆå®‰å…¨ï¼‰</h3>
        <div class="muted">æ•´ç†è£…å¤‡ã€åŠ å›ºé—¨çª—ã€åŸºç¡€ä½“èƒ½ï¼›2hï¼Œé£é™© -5ï¼Œä½“åŠ› -4ã€‚</div>
        <button class="btn small" onclick="train()">è®­ç»ƒ 2h</button>
      </div>
      <div class="card">
        <h3>ğŸš— å¤–å‡ºæœå¯»</h3>
        <div class="muted">3h é«˜é£é™©è¡ŒåŠ¨ï¼šå¯èƒ½è·å¾—ç‰©èµ„/ç‡ƒæ–™/å·¥å…·ï¼Œä¹Ÿå¯èƒ½é­é‡ä¸§å°¸æˆ–æ•Œå¯¹å¹¸å­˜è€…ã€‚</div>
        <button class="btn small" onclick="scavenge()">æœå¯» 3h</button>
      </div>
      <div class="card">
        <h3>ğŸ¯ æ‰“çŒ</h3>
        <div class="muted">3hï¼›åŸºç¡€ 30% æˆåŠŸç‡ï¼Œè‹¥æœ‰ç‹— +20%ã€‚æˆåŠŸè·å¾— 2~5 é¤ï¼Œå¤±è´¥å¯èƒ½ç•¥å¢é£é™©ã€‚</div>
        <button class="btn small" onclick="hunt()">æ‰“çŒ 3h</button>
      </div>
      <div class="card">
        <h3>ğŸ½ï¸ å»é¤é¦†åƒé¥­ï¼ˆä»…æœ«æ—¥å‰ï¼‰</h3>
        <div class="muted">æœ«æ—¥å‰çš„ä¸‰å¤©å¯å¤–å‡ºé¤é¦†ç”¨é¤ï¼›1hï¼›$20ï¼›ç²¾ç¥ +15ï¼›ä»… Day &lt; 0 å¯ç”¨ã€‚</div>
        <button class="btn small" onclick="eatOut()">é¤é¦†ç”¨é¤ 1h</button>
      </div>
      <div class="card">
        <h3>ğŸ’¡ æç¤º</h3>
        <ul class="muted" style="margin:0 0 0 18px">
          <li>é’“é±¼éœ€è¦å…ˆåœ¨ Walmart è´­ä¹°é’“é±¼ç«¿ã€‚</li>
          <li>æœ«æ—¥å¼€å§‹ï¼ˆDay â‰¥ 0ï¼‰åï¼Œé‡‡è´­æ¸ é“å…³é—­ï¼Œé¤é¦†ä¹Ÿä¸å†è¥ä¸šã€‚</li>
          <li>è½¦è¾†å®¹é‡è¶…å‡ºä¼šé¢å¤–æ¶ˆè€— 1 å°æ—¶ã€‚</li>
          <li>é£é™© &gt; 50 æ—¶ï¼Œå¯èƒ½é­é‡å¹¸å­˜è€…æˆ–å¼ºåŒ–ä¸§å°¸ã€‚</li>
        </ul>
      </div>
    </div>
  `;
}

function hunt(){ 
  if(guardIndoorOnly()) return; 
  if(!needHours(3, +6)) return; 
  let p = 0.30; 
  if(S.pet==='dog') p += 0.20; 
  if(Math.random()<p){
    const cuts = 1 + Math.floor(Math.random()*2);
    S.inventory.venison_raw = (S.inventory.venison_raw||0) + cuts;
    S.usedSlots += cuts; 
    S.unlocks.grill_venison = true;
    const gain = 2 + Math.floor(Math.random()*4);
    S.meals += gain;
    S.mood = Math.min(100, S.mood + 3);
    const forage = ['wild_veg','wild_berry','herb_basil','herb_mint'];
    const pickN = 1 + Math.floor(Math.random()*2);
    for(let i=0;i<pickN;i++){ const k = forage[Math.floor(Math.random()*forage.length)]; S.inventory[k]=(S.inventory[k]||0)+1; S.usedSlots+=1; }
    showMsg('æ‰“çŒæˆåŠŸ','è·å¾—ç”Ÿé¹¿è‚‰ Ã—'+cuts+'ï¼ˆè§£é”çƒ¤é¹¿è‚‰ï¼‰ï¼Œå¦å¾—é¤æ•° +'+gain+'ï¼Œå¹¶é‡‡æ‘˜äº†ä¸€äº›é‡æœã€‚');
    addLog(`æ‰“çŒæˆåŠŸï¼šç”Ÿé¹¿è‚‰ +${cuts} Â· é¤æ•° +${gain} Â· ç²¾ç¥ +3 Â· é‡‡æ‘˜ +${pickN}`);
  } else { 
    S.risk = Math.min(100, S.risk + 5);
    addLog('æ‰“çŒæ— åŠŸè€Œè¿”ï¼Œé£é™© +5');
  }
  checkOutdoorAttack('æ‰“çŒ'); 
  save(); render(); 
}



function eatOut(){ if(guardIndoorOnly()) return; if(guardIndoorOnly()) return;
  if(curDayAdj()>=0) return alert('æœ«æ—¥å·²å¼€å§‹ï¼Œé¤é¦†å·²åœä¸šã€‚');
  if(S.money<20) return alert('èµ„é‡‘ä¸è¶³');
  if(!needHours(1, +2)) return;
  S.money -= 20;
  S.mood = Math.min(100, S.mood + 15);
  S.stamina = Math.min(100, S.stamina + 20);
  S.hunger = Math.min(100, S.hunger + 20);
  addLog('å¤–å‡ºé¤é¦†ç”¨é¤ï¼š$20ï¼Œç²¾ç¥ +15 Â· ä½“åŠ› +20 Â· é¥±é£Ÿåº¦ +20');
  save(); render();
}

function goFish(){ if(guardIndoorOnly()) return; if(S.baseType!=='lake') return alert('éœ€è¦æ¹–è¾¹ house'); if(!(S.inventory.fishing_rod>0)) return alert('ç¼ºå°‘é’“é±¼ç«¿'); if(!needHours(2, +3)) return; const gain=1+Math.floor(Math.random()*3);
  // åŒæ—¶è·å¾—ç”Ÿé±¼ï¼Œè§£é”çƒ¤é±¼
  const fish = 1 + Math.floor(Math.random()*2); // 1~2 æ¡
  S.inventory.fish_raw = (S.inventory.fish_raw||0) + fish;
  S.usedSlots += fish;
  S.unlocks.grill_fish = true;
  S.meals += gain;
  S.mood=Math.min(100,S.mood+2);
  showMsg('é’“é±¼æˆåŠŸ','è·å¾—ç”Ÿé±¼ Ã—'+fish+'ï¼Œå¹¶è§£é”ã€Œçƒ¤é±¼ã€ã€‚å¦å¾—é¤æ•° +'+gain+'ã€‚');
  addLog(`é’“é±¼æ”¶è· ${gain} é¤ Â· ç”Ÿé±¼ +${fish}`); checkOutdoorAttack('é’“é±¼'); save(); render(); }
function setupGarden(){ if(guardIndoorOnly()) return; if(!(S.inventory.seeds>0)) return alert('ç¼ºå°‘ç§å­'); if(!needHours(2, +2)) return; S.garden.plots+=1; S.inventory.seeds--; S.usedSlots-=shopItemSlot('seeds'); addLog('å¼€å¦ 1 ä¸ªåœ°å—ã€‚'); checkOutdoorAttack('å¼€å¦åœ°å—'); save(); render(); }
function tendGarden(){ if(guardIndoorOnly()) return; if(S.garden.plots<=0) return alert('æ²¡æœ‰åœ°å—'); if(S.waterL<1) return alert('éœ€è¦è‡³å°‘ 1L æ°´'); if(!needHours(2, +1)) return; const eff = S.garden.skill? 20:10; S.garden.progress=Math.min(100,S.garden.progress+eff); S.waterL-=1; addLog(`ç…§æ–™èœåœ°ï¼Œè¿›åº¦ +${eff}%ã€‚`); checkOutdoorAttack('ç…§æ–™èœåœ°'); save(); render(); }
function harvest(){ if(guardIndoorOnly()) return; if(S.garden.progress<100) return alert('è¿˜æœªæˆç†Ÿ'); const gain= S.garden.plots * (S.garden.skill? 10:7); S.meals+=gain; S.garden.progress=0; addLog(`æ”¶è·è”¬èœï¼š+${gain} é¤ã€‚`); checkOutdoorAttack('æ”¶è·'); save(); render(); }

function study(bookId){
  if(!S.mastery){ S.mastery={garden:0,generator:0,firstaid:0,repair:0}; }
  const map = {
    'book_garden': {key:'garden', name:'å®¶åº­å›­è‰ºå…¥é—¨'},
    'book_gen': {key:'generator', name:'å‘ç”µæœºç»´æŠ¤'},
    'book_firstaid': {key:'firstaid', name:'æ€¥æ•‘æ‰‹å†Œ'},
    'book_repair': {key:'repair', name:'å±…å®¶ä¿®è¡¥æŒ‡å—'}
  };
  const conf = map[bookId];
  if(!conf) return;
  const cur = (S.mastery[conf.key]||0);
  if(cur >= 100){
    addLog('ã€Š'+conf.name+'ã€‹å·²æ»¡çº§ï¼ˆ100%ï¼‰ï¼Œæ— éœ€ç»§ç»­å­¦ä¹ ã€‚');
    render();
    return;
  }
  if(!(S.inventory && S.inventory[bookId]>0)) return alert('ç¼ºå°‘ä¹¦ç±ï¼šã€Š'+conf.name+'ã€‹');
  if(!needHours(2, 0)) return;
  S.mastery[conf.key] = Math.min(100, cur + 10);
  if(conf.key==='garden' && S.mastery.garden>=50){ S.garden.skill = true; }
  if(conf.key==='repair' && S.mastery.repair>=50){ S.skills.repair = true; }
  addLog('å­¦ä¹ ã€Š'+conf.name+'ã€‹å®Œæˆï¼šæŠ€èƒ½æŒæ¡ +10%ï¼ˆç°ä¸º '+S.mastery[conf.key]+'%ï¼‰ Â· ç›¸å…³è¡ŒåŠ¨æˆåŠŸç‡ +20%');
  save();
  render();
}
function train(){ if(!needHours(2, -5)) return; addLog('è®­ç»ƒå®Œæˆï¼šé£é™© -5ã€‚'); save(); render(); }
function scavenge(){ if(guardIndoorOnly()) return; if(!needHours(3, +12)) return; const roll=Math.random(); if(roll<0.25){ const gain= 1+Math.floor(Math.random()*3); S.meals+=gain; addLog(`æ‰¾åˆ°åºŸå¼ƒé£Ÿå“ï¼š+${gain} é¤ã€‚`);} else if(roll<0.45){ S.waterL+=3; addLog('æ‰¾åˆ°ç“¶è£…æ°´ï¼š+3Lã€‚'); } else if(roll<0.6){ S.gasGal+=2; addLog('åœ¨åºŸå¼ƒåŠ æ²¹ç«™è™¹å¸ï¼šæ±½æ²¹ +2galã€‚'); } else if(roll<0.75){ if(S.wep.melee||S.wep.handgun||S.wep.rifle){ addLog('é­é‡åŠ«åŒªä½†è¢«ä½ å“é€€ã€‚'); } else { addLog('é­é‡åŠ«åŒªï¼ŒæŸå¤±å°‘é‡ç‰©èµ„ï¼Œç²¾ç¥ -5ã€‚'); S.mood=Math.max(0,S.mood-5); S.usedSlots=Math.max(0,S.usedSlots-2); } } else if(roll<0.9){ addLog('ç©ºæ— ä¸€ç‰©ï¼Œç™½å¿™æ´»ä¸€åœºã€‚'); } else {
    addLog('ä¸§å°¸å›´æ”»ï¼ä½ ä»“çš‡æ’¤é€€ï¼Œä½“åŠ› -10ï¼Œç²¾ç¥ -8ã€‚'); S.stamina=Math.max(0,S.stamina-10); S.mood=Math.max(0,S.mood-8);
  }
  save(); render(); }

// ======== åŒä¼´/å® ç‰© ========
const PRE_DAY_LIMIT = 0;
function renderTeam(box){
  const canRecruit = curDayAdj()<PRE_DAY_LIMIT && S.team.length<2;
  const teamRows = S.team.map((t,i)=>`<tr><td>${t.name}ï¼ˆ${t.typeZh}ï¼‰</td><td class=\"right\">â€”</td></tr>`).join('') || '<tr><td>æš‚æ— åŒä¼´</td><td></td></tr>';
  box.innerHTML = `
    <div class=\"grid\">
      <div class=\"card\">
        <h3>ğŸ‘¥ åŒä¼´</h3>
        <div class=\"muted\">æœ«æ—¥å‰å¯æ‹›å‹Ÿæœ€å¤š 2 ä½åŒä¼´ï¼›åŒä¼´ä¸ä¼šèƒŒå›ï¼Œä½†ä¼šä¸æ‚¨äº§ç”Ÿåˆ†æ­§ï¼ˆä»¥ç²¾ç¥å°å¹…æ¶ˆè€—ä½“ç°ï¼‰ã€‚åŒä¼´æ¯å¤©ä¹Ÿè¦åƒå–ã€‚</div>
        ${canRecruit? `<div class=\"row\" style=\"margin:8px 0\">
          <button class=\"btn small\" onclick=\"addMate('scholar')\">æ‹›å‹Ÿ å­¦éœ¸</button>
          <button class=\"btn small\" onclick=\"addMate('athlete')\">æ‹›å‹Ÿ è¿åŠ¨å‘˜</button>
          <button class=\"btn small\" onclick=\"addMate('medic')\">æ‹›å‹Ÿ åŒ»å­¦ç”Ÿ</button>
          <button class=\"btn small\" onclick=\"addMate('chef')\">æ‹›å‹Ÿ å¨è‰ºè¾¾äºº</button>
        </div>` : '<div class=\"pill\">å½“å‰ä¸å¯æ‹›å‹Ÿï¼ˆå·²è¿‡æœ«æ—¥å‰æœŸæˆ–å·²æ»¡å‘˜ï¼‰</div>'}
        <table><tbody>${teamRows}</tbody></table>
      </div>
      <div class=\"card\">
        <h3>ğŸ¾ å® ç‰©</h3>
        <div>å½“å‰ï¼š${S.pet? (S.pet==='dog'?'ğŸ• å°ç‹—':'ğŸˆ å°çŒ«') : 'æœªé€‰æ‹©'}</div>
        <div class=\"muted\">å® ç‰©æ¯æ—¥è‡ªåŠ¨æ¶ˆè€—å¯¹åº”çš„å® ç‰©ç²®ï¼šç‹— 1 å¤© / çŒ« 1 å¤©ã€‚è‹¥å® ç‰©ç²®ä¸è¶³å°†é™ä½ç²¾ç¥åº¦ï¼ˆç‹— -10ï¼ŒçŒ« -5ï¼‰ã€‚</div>
        <div class=\"muted\">å® ç‰©ç²®éœ€åœ¨è¶…å¸‚è´­ä¹°ï¼ˆCostco/Walmartï¼‰ï¼Œ<b>ä¸å†å­˜åœ¨å® ç‰©åº—</b>ã€‚</div>
        <div class=\"muted\">ç‹—æä¾› +7 ç²¾ç¥ä¸”å¯èƒ½å¸¦æ¥ +1 é£é™©ï¼›çŒ«æä¾› +5 ç²¾ç¥ä¸”ä¸å¼•æ•Œã€‚</div>
      </div>
    </div>
  `;
}
function addMate(type){
  const map = {scholar:{name:'å­¦éœ¸', typeZh:'è§„åˆ’å‡å‹'}, athlete:{name:'è¿åŠ¨å‘˜', typeZh:'æˆ˜æ–—å¼º'}, medic:{name:'åŒ»å­¦ç”Ÿ', typeZh:'åŒ»ç–—åŠ æˆ'}, chef:{name:'å¨è‰ºè¾¾äºº', typeZh:'æ–™ç†å¢ç›Š'}};
  if(S.team.length>=2) return alert('é˜Ÿä¼å·²æ»¡');
  S.team.push({id:Date.now()+''+Math.floor(Math.random()*1000), name:map[type].name, type, typeZh:map[type].typeZh});
  addLog(`åŠ å…¥åŒä¼´ï¼š${map[type].name}`); save(); render();
}

// ======== ä»“åº“ ========
function renderInv(box){
  const invRows = Object.entries(S.inventory).sort().map(([id,q])=>{ const item = findItem(id); return `<tr><td>${item?item.name:id}</td><td>${q} ${item?item.unit:''}</td></tr>`; }).join('');
  box.innerHTML = `<div class=\"grid\"><div class=\"card\"><h3>ğŸ“¦ ä»“åº“æ€»è§ˆ</h3><div class=\"row\"><div class=\"pill ${S.usedSlots>=S.storeCap? 'bad' : ( (S.storeCap-S.usedSlots)/S.storeCap<=0.1? 'warn':'ok')}\">å·²ç”¨ ${S.usedSlots}/${S.storeCap} æ ¼</div><div class=\"pill\">é¤æ•°ï¼š${S.meals}</div><div class=\"pill\">é¥®æ°´ï¼š${S.waterL} L</div><div class=\"pill\">å†·é“¾ï¼š${S.coldDays} å¤©</div><div class=\"pill\">æ±½æ²¹ï¼š${S.gasGal.toFixed(1)} gal</div><div class=\"pill\">ä¸™çƒ·ï¼š${S.propane}</div><div class=\"pill\">ç‹—ç²®å¤©æ•°ï¼š${S.petFoodDays.dog}</div><div class=\"pill\">çŒ«ç²®å¤©æ•°ï¼š${S.petFoodDays.cat}</div></div></div><div class=\"card\"><h3>æ¸…å•</h3><table><tbody>${invRows||'<tr><td>æš‚æ— ç‰©èµ„</td><td></td></tr>'}</tbody></table></div></div>`;
}
function findItem(id){ for(const k in SHOPS){ const f = SHOPS[k].items.find(x=>x.id===id); if(f) return f; } const virtualItems={fish_raw:{name:'ç”Ÿé±¼',unit:'æ¡'}, venison_raw:{name:'ç”Ÿé¹¿è‚‰',unit:'ä»½'}, boar_raw:{name:'é‡çŒªè‚‰',unit:'ä»½'}, wild_veg:{name:'é‡èœ',unit:'ä»½'}, wild_berry:{name:'é‡æœ',unit:'ä»½'}, herb_basil:{name:'é‡ç½—å‹’',unit:'æŸ'}, herb_mint:{name:'é‡è–„è·',unit:'æŸ'}, trap:{name:'ç®€æ˜“é™·é˜±',unit:'åª'}}; return virtualItems[id]||null; }


function repairFence(){
  if(!needHours(2, +2)) return;
  let ok = false;
  if(S.skills.repair) ok = true;
  else ok = Math.random() < 0.6;
  if(ok){
    S.wireBroken = false;
    S.risk = Math.max(0, S.risk - 5);
    addLog('ä¿®è¡¥å®Œæˆï¼šå›´æ å·²æ¢å¤ï¼Œé£é™© -5ã€‚');
    showMsg('ä¿®è¡¥å®Œæˆ','ä½ æˆåŠŸä¿®å¤äº†é“ä¸ç½‘ï¼Œåº‡æŠ¤æ‰€æ›´åŠ å®‰å…¨äº†ã€‚');
  }else{
    addLog('ä¿®è¡¥å¤±è´¥ï¼šéœ€è¦æ›´å¤šæŠ€å·§æˆ–æ—¶é—´ã€‚');
    showMsg('ä¿®è¡¥å¤±è´¥','ä¿®è¡¥æ²¡æœ‰æˆåŠŸï¼Œå¯èƒ½éœ€è¦å­¦ä¹ ã€Šå±…å®¶ä¿®è¡¥æŒ‡å—ã€‹ã€‚');    
  }
  save(); render();
}

// ======== ç¡è§‰/æ—¥ç»“ ========


// ==== æˆ˜æ–—ä¸è¢­å‡»å·¥å…· ====
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

// æ¶ˆè€—å¼¹è¯ï¼šä¼˜å…ˆä½¿ç”¨æ­¥æªï¼ˆ5.56ï¼‰ï¼Œä¸è¶³åˆ™ç”¨æ‰‹æªï¼ˆ9mmï¼‰ã€‚è¿”å› {used556, used9, unmet}
function spendAmmo(need){
  let used556 = 0, used9 = 0, unmet = 0;
  // åªæœ‰æŒæœ‰å¯¹åº”æ­¦å™¨æ‰ä¼šæ¶ˆè€—è¯¥å£å¾„
  if(S.wep.rifle && S.wep.ammo556>0){
    const take = Math.min(need, S.wep.ammo556);
    S.wep.ammo556 -= take; used556 += take; need -= take;
  }
  if(need>0 && S.wep.handgun && S.wep.ammo9>0){
    const take = Math.min(need, S.wep.ammo9);
    S.wep.ammo9 -= take; used9 += take; need -= take;
  }
  unmet = Math.max(0, need);
  if(used556>0 || used9>0){
    addLog(`æ¶ˆè€—å¼¹è¯ï¼š5.56 Ã—${used556} Â· 9mm Ã—${used9}`);
  }
  return {used556, used9, unmet};
}

// å®¤å¤–/å¤œè¢­å…±ç”¨ï¼šå°è§„æ¨¡ä¸§å°¸/å¹¸å­˜è€…/å°¸æ½®
function resolveAttack(kind, ctx){
  // kind: 'zombie' | 'raider' | 'horde'
  const hasGun = (S.wep.rifle && S.wep.ammo556>0) || (S.wep.handgun && S.wep.ammo9>0);
  const hasMelee = S.wep.melee;
  let needAmmo = 0, moodHit = 0, staHit = 0, riskDelta = 0, wireBreak = false;
  if(kind==='zombie'){
    needAmmo = 8 + Math.floor(Math.random()*13); // 8~20
    moodHit = 4; staHit = 6; riskDelta = +5;
    if(Math.random()<0.15) wireBreak = true;
  }else if(kind==='raider'){
    needAmmo = 10 + Math.floor(Math.random()*16); // 10~25
    moodHit = 6; staHit = 8; riskDelta = +6;
    if(Math.random()<0.10) wireBreak = true;
  }else{ // horde
    needAmmo = 60 + Math.floor(Math.random()*91); // 60~150
    moodHit = 12; staHit = 18; riskDelta = +12;
    wireBreak = true;
  }

  // ä½¿ç”¨å¼¹è¯
  let unmet = needAmmo;
  if(hasGun){
    const r = spendAmmo(needAmmo);
    unmet = r.unmet;
  }

  // è‹¥æ— æª/å¼¹ä¸è¶³ï¼Œç”¨è¿‘æˆ˜æˆ–å—ä¼¤æ’¤é€€
  if(unmet>0 && !hasMelee){
    // çº¯æ’¤é€€ï¼Œä¼¤å®³æ›´å¤§
    staHit += 6; moodHit += 4;
  }

  // åº”ç”¨å½±å“
  S.stamina = Math.max(0, S.stamina - staHit);
  S.mood = Math.max(0, S.mood - moodHit);
  S.risk = clamp(S.risk + riskDelta, 0, 100);

  // å›´æ æŸå
  if(wireBreak){
    S.wireBroken = true;
    addLog('å›´æ å—æŸï¼šé“ä¸ç½‘ç ´è£‚ï¼Œéœ€å°½å¿«ä¿®è¡¥ï¼');
  }

  // æ–‡æ¡ˆ
  if(kind==='zombie'){
    addLog(`${ctx}é­åˆ°ä¸§å°¸è¢­å‡»ï¼šä½“åŠ› -${staHit} Â· ç²¾ç¥ -${moodHit} Â· é£é™© +${riskDelta}`);
    showMsg('ä¸§å°¸è¢­å‡»', 'ä¸€ç›´ä¸§å°¸ä¼ æ¥ä½å¼ï¼Œä½ è¢«è¿«å¼€ç«è‡ªä¿ã€‚');
  }else if(kind==='raider'){
    addLog(`${ctx}é­åˆ°å¹¸å­˜è€…è¢­å‡»ï¼šä½“åŠ› -${staHit} Â· ç²¾ç¥ -${moodHit} Â· é£é™© +${riskDelta}`);
    showMsg('å¹¸å­˜è€…è¢­å‡»', 'å¯¹æ–¹ç«åŠ›è¯•æ¢ï¼Œä½ è¢«è¿«è¿˜å‡»å¹¶é©±æ•£ã€‚');
  }else{
    addLog(`${ctx}é­é‡å°¸æ½®ï¼ä½“åŠ› -${staHit} Â· ç²¾ç¥ -${moodHit} Â· é£é™© +${riskDelta} Â· å›´æ å—æŸ`);
    showMsg('å°¸æ½®æ¥è¢­', 'é»‘å‹å‹çš„ä¸€ç‰‡é€¼è¿‘ï¼Œä½ æ‹¼å‘½æŠµæŒ¡ã€‚');
  }
}

// å¤œé—´åˆ·æ–°ï¼šæŒ‰é£é™©å†³å®šæ˜¯å¦è§¦å‘ä¸€æ¬¡â€œè¢­å‡»ç±»äº‹ä»¶â€
function nightlyRaids(){
  if(curDayAdj()<0) return; // æœ«æ—¥å‰ä¸è§¦å‘
  let baseP = clamp(S.risk/120, 0, 0.75);  // é£é™©è¶Šé«˜è¶Šå®¹æ˜“è¢«æ‰¾ä¸Šé—¨
  if(S.wireBroken) baseP += 0.15;
  if(Math.random() < baseP){
    const r = Math.random();
    if(r < 0.45) resolveAttack('zombie', 'å¤œé—´');
    else if(r < 0.75) resolveAttack('raider', 'å¤œé—´');
    else resolveAttack('horde', 'å¤œé—´');
  }
}

function sleepNow(){
  const curH = hourMod();
  const curD = curDayAdj();
  // Determine wake day/time
  const wakeDay = (curH < 8) ? curD : (curD + 1);
  const sleepH = (curH < 8) ? (8 - curH) : ((24 - curH) + 8);

  const staGain = sleepH>=8? 50 : sleepH>=4? 25 : 10;
  S.stamina = Math.min(100, S.stamina + staGain);

  // æ¯æ—¥åŸºç¡€ç²¾ç¥æ¶ˆè€—
  let moodDrop = 5;
  if(!S.toilet) moodDrop += 10;
  if(S.team.find(t=>t.type==='scholar')) moodDrop = Math.max(0, moodDrop-1);

  // æ¯æ—¥é£Ÿæ°´ï¼ˆç©å®¶ + åŒä¼´ï¼‰
  let needMeals = 2 + S.team.length;
  let needWater = 3 + S.team.length*0.5;
  let ate = false;

  if(S.meals>=needMeals){ S.meals -= needMeals; ate = true; S.stamina = Math.min(100, S.stamina + 15); addLog('è¿›é£Ÿï¼šä½“åŠ› +15'); } 
  else { S.stamina = Math.max(0, S.stamina - 10); addLog('é¥±é£Ÿåº¦è¿‡ä½å½±å“ä½“åŠ› -10'); moodDrop += 5; }

  if(S.waterL>=needWater){ S.waterL -= needWater; } 
  else { S.stamina = Math.max(0, S.stamina - 20); addLog('ç¼ºæ°´å½±å“ä½“åŠ› -20'); moodDrop += 5; }

  // é¥±é£Ÿåº¦ä¸é¥¿æ­»å€’è®¡æ—¶ï¼ˆç¡è§‰ä¸å†å¢åŠ é¥±é£Ÿåº¦ï¼›ä»…åœ¨æœªè¿›é£Ÿæ—¶ä¸‹é™ï¼‰
  if(!ate){ S.hunger = Math.max(0, S.hunger - 35); }
  if(S.hunger<=0){
    S.starveDays = (S.starveDays||0) + 1;
    addLog(`æåº¦é¥¥é¥¿ï¼ˆç¬¬ ${S.starveDays}/3 å¤©ï¼‰`);
  } else {
    S.starveDays = 0;
  }

  // å® ç‰©
  if(S.pet==='dog'){
    S.mood = Math.min(100, S.mood + 7);
    if(S.petFoodDays.dog>0) { S.petFoodDays.dog -= 1; }
    else { S.mood = Math.max(0, S.mood - 10); addLog('ç‹—ç²®ä¸è¶³ï¼Œå°ç‹—é¥¥é¥¿ï¼Œç²¾ç¥ -10'); }
  }
  if(S.pet==='cat'){
    S.mood = Math.min(100, S.mood + 5);
    if(S.petFoodDays.cat>0) { S.petFoodDays.cat -= 1; }
    else { S.mood = Math.max(0, S.mood - 5); addLog('çŒ«ç²®ä¸è¶³ï¼Œå°çŒ«é¥¥é¥¿ï¼Œç²¾ç¥ -5'); }
  }

  // è¢«åŠ¨æ”¶ç›Š
  if(S.baseType==='lake') { S.waterL += 2; addLog('æ¹–è¾¹å–æ°´ï¼š+2L'); }
  if(S.baseType==='suburb') { S.meals += 1; addLog('éƒŠå¤–é‡‡é›†/æ‰“çŒï¼š+1 é¤'); }

  // å†·é“¾
  if(powerAvailable() && S.freezer){ S.coldDays = Math.min(7, S.coldDays + 1); } else { if(S.coldDays>0) S.coldDays -= 1; }
  if(S.coldDays<=0){
    const spoilKeys = ['eggs60','cheese2k','freezer_meat'];
    spoilKeys.forEach(k=>{ const n=S.inventory[k]||0; if(n>0){ const lost=Math.ceil(n*0.5); S.inventory[k]=Math.max(0,n-lost); if(S.inventory[k]===0) delete S.inventory[k]; addLog(`${findItem(k)?.name||k} å˜è´¨ï¼ŒæŸå¤± ${lost}`); }});
  }

  // éšæœºäº‹ä»¶ï¼ˆé«˜é£é™©åå‘å¹¸å­˜è€…/ä¸§å°¸ï¼‰
  let riskNow = S.risk; if(S.skills.guard) riskNow = Math.max(0,riskNow-5);
  const p = Math.min(0.6, riskNow/100); 
  if(Math.random()<p){ 
    let cand = EVENTS.filter(e=>riskNow>=e.minRisk);
    if(riskNow>50){ cand = cand.filter(e=> e.id==='survivor' || e.id==='zombie_evo'); if(cand.length===0) cand = EVENTS; }
    const ev = cand[Math.floor(Math.random()*cand.length)]; 
    if(ev){ ev.effect(S); addLog(`äº‹ä»¶ï¼š${ev.text}`); if(S.wep.handgun||S.wep.rifle||S.wep.melee) { addLog('ä½ çš„é˜²èº«è£…å¤‡è®©å±€é¢å¯æ§ã€‚'); S.risk=Math.max(0,S.risk-5); } } 
  }

  // å›¢é˜Ÿåˆ†æ­§
  if(S.team.length && Math.random()<0.4){ addLog('å›¢é˜Ÿåˆ†æ­§ï¼šæ˜¯å¦å¤–å‡ºæœå¯»ï¼Ÿç²¾ç¥ -2'); moodDrop += 2; }

  // ç”µç½‘é€æ­¥æ–­ç”µ
  if(wakeDay>=0 && Math.random()<0.4) S.gridOn=false;

  // ç²¾ç¥ç»“ç®—
  S.mood = Math.max(0, S.mood - moodDrop);

  // é†’æ¥
  S.day = wakeDay; 
  S.hour = 8; 
  S.hoursLeft = 12; 
  S.allowOver=false; 
  S.news = WORLD_NEWS[Math.floor(Math.random()*WORLD_NEWS.length)];
    // å¤œé—´è¢­å‡»åˆ·æ–°ï¼ˆå¯èƒ½æ¶ˆè€—å¼¹è¯/ç ´åå›´æ ï¼‰
  nightlyRaids();
// å›´æ æŸåæ—¶ï¼šå¿…å®šå‘ç”Ÿä¸€æ¬¡ä¸§å°¸ç›¸å…³äº‹ä»¶
  if(S.wireBroken){
    const cand = EVENTS.filter(e=> e.id==='zombie_evo');
    const ev = cand[Math.floor(Math.random()*cand.length)];
    if(ev){ ev.effect(S); addLog(`äº‹ä»¶ï¼š${ev.text}`); }
  }


  if(S.mood<=0){ alert('ç²¾ç¥å´©æºƒï¼Œæ¸¸æˆç»“æŸ'); return resetGame(); }
  if(S.stamina<=0){ alert('ä½“åŠ›è€—å°½ï¼Œæ¸¸æˆç»“æŸ'); return resetGame(); }
  if(S.starveDays>=3){ alert('å› é•¿æœŸé¥¥é¥¿æ­»äº¡ï¼Œæ¸¸æˆç»“æŸ'); return resetGame(); }

  save(); render();
}


function resetGame(){ if(!confirm('é‡å¼€ï¼Ÿå½“å‰è¿›åº¦ä¼šè¢«æ¸…ç©º')) return; S = initState(); save(); render(); }

// ======== å¯åŠ¨ ========
render();

// --- Mobile press helper: ensures taps fire clicks on iOS/Android ---
function enableMobilePressRoot(){
  if(!window.PointerEvent) return;
  const handler = (e) => {
    if(e.pointerType === 'touch' || e.pointerType === 'pen'){
      const el = e.target.closest('button,.btn,.tab,[role="button"]');
      if(el && !el.disabled){
        // Prevent double-activation by stopping the synthetic click
        e.preventDefault?.();
        // Dispatch a click only if the element doesn't already handle pointerup
        // Using setTimeout to come after any internal pointerup handlers
        setTimeout(() => { el.click(); }, 0);
      }
    }
  };
  // capture to run before other listeners, passive:false so we can prevent default when needed
  window.addEventListener('pointerup', handler, {passive:false, capture:true});
}


// --- (Optional) Audio unlock stub for iOS ---
let __audioUnlocked = false;
function __unlockAudioOnce(){
  if(__audioUnlocked) return;
  const AC = window.AudioContext || window.webkitAudioContext;
  if(!AC) { __audioUnlocked = true; return; }
  try{
    const ctx = new AC();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    gain.gain.value = 0;
    osc.connect(gain).connect(ctx.destination);
    osc.start(0); osc.stop(0.01);
    __audioUnlocked = true;
  }catch(e){ __audioUnlocked = true; }
}
window.addEventListener('pointerdown', __unlockAudioOnce, {once:true});
window.addEventListener('touchstart', __unlockAudioOnce, {once:true});

</script>

<script>
// --- Global mobile tap delegator (v2) ---
(function(){
  var lastSynthAt = 0;
  function wantsClick(el){
    if(!el) return false;
    // Elements inherently clickable or carrying inline handlers
    if (el.tagName === 'BUTTON' || el.tagName === 'A' || el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') return true;
    if (typeof el.onclick === 'function') return true;
    if (el.hasAttribute('onclick')) return true;
    if (el.getAttribute('role') === 'button') return true;
    if (el.classList && (el.classList.contains('btn') || el.classList.contains('button') || el.classList.contains('tab') || el.classList.contains('tile'))) return true;
    return false;
  }
  function findClickable(start){
    var el = start;
    while(el && el !== document.body){
      if (wantsClick(el)) return el;
      el = el.parentElement;
    }
    return null;
  }
  function synthClick(target){
    var ev = new MouseEvent('click', {bubbles:true, cancelable:true, view:window});
    target.dispatchEvent(ev);
  }
  function onPointerUp(e){
    if(!(e.pointerType === 'touch' || e.pointerType === 'pen')) return;
    var now = Date.now();
    // If we recently synthesized a click, don't do it again
    if (now - lastSynthAt < 120) return;
    var el = findClickable(e.target);
    if(el && !el.disabled){
      // Prevent potential double-activation from subsequent synthetic "click"
      e.preventDefault();
      lastSynthAt = now;
      setTimeout(function(){ synthClick(el); }, 0);
    }
  }
  if (window.PointerEvent){
    window.addEventListener('pointerup', onPointerUp, {passive:false, capture:true});
  }else{
    // Fallback for very old browsers
    window.addEventListener('touchend', function(e){
      var el = findClickable(e.target);
      if(el && !el.disabled){
        e.preventDefault();
        synthClick(el);
      }
    }, {passive:false, capture:true});
  }
})();
</script>
</body>
</html>
