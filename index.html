<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æœ«æ—¥å›¤è´§ç”Ÿå­˜ Â· å•æ–‡ä»¶ç½‘é¡µæ¸¸æˆ</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#10161c; --card:#131b23; --line:#232e3a; --text:#f5f7fa; --muted:#9fb0c2;
      --accent:#ff4d4f; --ok:#14e099; --warn:#ffcc4d; --vio:#6c5ce7;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e1420);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial;}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{font-size:28px;margin:8px 0 12px 0}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .tile{background:#0f1622;border:1px solid var(--line);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}
    .btn{background:#1f2937;color:#fff;border:1px solid #0000;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent)}
    .btn.good{background:var(--ok);color:#072}
    .btn.ghost{background:transparent;border:1px solid var(--line)}
    .btn.small{padding:6px 10px;border-radius:10px}
    .stat{display:flex;gap:12px}
    .kpi{flex:1;min-width:160px;background:#0f1622;border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi .lab{font-size:12px;color:var(--muted)}
    .kpi .num{font-size:24px;font-weight:800}
    .bar{height:8px;background:#0d121a;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,#ff4d4f,#ff7a45)}
    .pill{padding:4px 10px;border-radius:999px;font-size:12px}
    .pill.ok{background:rgba(20,224,153,.18);color:var(--ok)}
    .pill.warn{background:rgba(255,204,77,.2);color:var(--warn)}
    .pill.bad{background:rgba(255,77,79,.2);color:#ff6b6b}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tab{padding:10px 14px;border:1px solid var(--line);border-radius:12px;cursor:pointer}
    .tab.active{background:var(--accent);border-color:transparent}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:10px 12px}
    tbody tr{background:#0f1622;border:1px solid var(--line)}
    tbody tr td:first-child{border-radius:10px 0 0 10px}
    tbody tr td:last-child{border-radius:0 10px 10px 0}
    input[type=number]{width:90px;background:#0d1620;border:1px solid var(--line);color:#fff;border-radius:10px;padding:8px}
    .right{text-align:right}

    .footer{opacity:.6;text-align:center;margin:18px 0 8px}
    .notice{border-left:4px solid var(--accent);padding-left:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ§Ÿâ€â™‚ï¸ æœ«æ—¥å›¤è´§ç”Ÿå­˜ Â· ç½‘é¡µç‰ˆï¼ˆå•æ–‡ä»¶ï¼‰</h1>
  <div class="muted">å•äººå›åˆåˆ¶ Â· æœ¬åœ°å­˜æ¡£ï¼ˆLocalStorageï¼‰ Â· è§„åˆ™é©±åŠ¨ï¼ˆæ— åç«¯ï¼‰</div>

  <!-- é¡¶éƒ¨ KPI -->
  <div class="stat" id="kpi">
    <div class="kpi"><div class="lab">æ—¥æœŸ</div><div class="num" id="dayLab"></div><div class="muted" id="hourLab"></div></div>
    <div class="kpi"><div class="lab">èµ„é‡‘ï¼ˆ$ï¼‰</div><div class="num" id="moneyLab"></div><div class="bar"><i id="moneyBar" style="width:50%"></i></div></div>
    <div class="kpi"><div class="lab">ä½“åŠ›</div><div class="num" id="staLab"></div><div class="bar"><i id="staBar" style="width:80%"></i></div></div>
    <div class="kpi"><div class="lab">ä»Šæ—¥å‰©ä½™å·¥æ—¶</div><div class="num" id="hoursLeftLab"></div><div class="muted">å¯é€æ”¯ <input type="checkbox" id="allowOver">ï¼ˆç”¨ç¡çœ æŠµæ‰£ï¼‰</div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs" id="tabs"></div>

  <!-- Panels -->
  <div id="panel"></div>

  <div class="footer">Â© Survival Web Demo Â· ä¿å­˜ï¼šè‡ªåŠ¨ Â· å»ºè®®éƒ¨ç½²åˆ° GitHub Pages</div>
</div>

<script>
const LS_KEY = 'survival_web_v1';

// ======== ç‰©èµ„ä¸å•†åº—å®šä¹‰ ========
const SHOPS = {
  costco: {
    name:'Costco é£Ÿå“/ç”Ÿæ´»', travelH:3, unloadH:2,
    items:[
      {id:'rice50', name:'å¤§ç±³ 50lb', price:35, unit:'è¢‹', slot:10, meals:240},
      {id:'pasta6', name:'æ„é¢ 6lb ç®±', price:10, unit:'ç®±', slot:3, meals:30},
      {id:'canned', name:'ç½å¤´ 12ç½', price:12, unit:'ç®±', slot:5, meals:24},
      {id:'bars', name:'èƒ½é‡æ£’ 30æ¡', price:18, unit:'ç›’', slot:3, meals:30},
      {id:'water24', name:'ç“¶è£…æ°´ 24Ã—500ml', price:4, unit:'ç®±', slot:2, waterL:12},
      {id:'oil5l', name:'é£Ÿç”¨æ²¹ 5L', price:12, unit:'æ¡¶', slot:3},
      {id:'towel', name:'çº¸å·¾ æ•´ç®±', price:18, unit:'ç®±', slot:5},
      {id:'trashbag', name:'åƒåœ¾è¢‹ 200ä¸ª', price:15, unit:'åŒ…', slot:2},
      {id:'milkpow', name:'å¥¶ç²‰ 2.5kg', price:25, unit:'ç½', slot:4, meals:25},
      {id:'eggs60', name:'é¸¡è›‹ 60æš', price:12, unit:'ç›’', slot:4, meals:20, needCold:true},
      {id:'cheese2k', name:'å¥¶é…ª 2kg', price:20, unit:'å—', slot:5, meals:20, needCold:true},
    ]
  },
  cvs: {
    name:'CVS è¯å“', travelH:3, unloadH:1,
    items:[
      {id:'pain', name:'æ­¢ç—›è¯', price:10, unit:'ç“¶', slot:1},
      {id:'vit', name:'ç»´ç”Ÿç´ ', price:15, unit:'ç“¶', slot:1},
      {id:'alcohol', name:'æ¶ˆæ¯’æ¶² 1L', price:8, unit:'ç“¶', slot:1},
      {id:'mask', name:'å£ç½© 50åª', price:20, unit:'ç›’', slot:2},
      {id:'cold', name:'æ„Ÿå†’è¯', price:12, unit:'ç›’', slot:1},
      {id:'antinflam', name:'æ¶ˆç‚è¯(OTC)', price:15, unit:'ç›’', slot:1},
      {id:'band', name:'åˆ›å¯è´´+çº±å¸ƒ', price:5, unit:'å¥—', slot:0.5},
    ]
  },
  homedepot: {
    name:'Home Depot è®¾å¤‡/å»ºæ', travelH:3, unloadH:2,
    items:[
      {id:'solar', name:'å¤ªé˜³èƒ½æ¿å¥—è£… 1kW', price:2000, unit:'å¥—', slot:30, build:'solar', buildH:2},
      {id:'battery', name:'å‚¨èƒ½ç”µæ± (UPS)', price:1000, unit:'å°', slot:20, build:'battery', buildH:0},
      {id:'gen', name:'å‘ç”µæœº(ä¸­å‹)', price:800, unit:'å°', slot:20, build:'gen', buildH:2},
      {id:'handcrank', name:'æ‰‹æ‘‡å‘ç”µæœº', price:50, unit:'ä¸ª', slot:5},
      {id:'filter', name:'å®¶ç”¨å‡€æ°´æœº', price:200, unit:'å°', slot:10, build:'filter', buildH:3},
      {id:'rain', name:'é›¨æ°´æ”¶é›†æ¡¶ 50gal', price:250, unit:'åª', slot:20, build:'rain', buildH:2},
      {id:'board', name:'æœ¨æ¿', price:3, unit:'å—', slot:1, build:'board'},
      {id:'wire', name:'é“ä¸ç½‘å·', price:40, unit:'å·', slot:5, build:'wire'},
      {id:'tools', name:'å·¥å…·å¥—è£…', price:40, unit:'å¥—', slot:5},
      {id:'gascan', name:'æ±½æ²¹æ¡¶ 5gal ç©º', price:20, unit:'åª', slot:5},
    ]
  }
};

// å°†ç‰©èµ„æ˜ å°„æˆâ€œé¤æ•°/é¥®æ°´é‡â€çš„æ¢ç®—
const ITEM_EFFECTS = {
  rice50:{ meals:240 }, pasta6:{meals:30}, canned:{meals:24}, bars:{meals:30}, milkpow:{meals:25},
  eggs60:{meals:20}, cheese2k:{meals:20}, water24:{waterL:12}
};

// ======== åˆå§‹çŠ¶æ€ ========
function initState(){
  return {
    day:-3, hour:8, hoursLeft:12,
    money:30000,
    stamina:100, mood:70, hunger:0, thirst:0,
    allowOver:false,
    storeCap:500, usedSlots:0, // å®¶ä¸­ä»“åº“
    solar:false, battery:false, gen:false, filter:false, rain:false,
    boards:0, wires:0,
    inventory:{},
    meals:0, waterL:0,
    log:[{t:ts(), msg:'æ¸¸æˆå¼€å§‹ã€‚ä½ æå‰ 3 å¤©è·æ‚‰ç–«æƒ…ï¼Œå°†åœ¨ 2 å¤©å†…å®Œæˆå›¤è´§ä¸åŠ å›ºã€‚'}]
  }
}

let S = JSON.parse(localStorage.getItem(LS_KEY)) || initState();

// ======== å·¥å…·å‡½æ•° ========
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(S)); }
function ts(){ return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
function fmt(n){ return (n||0).toLocaleString(); }
function addLog(msg){ S.log.unshift({t:ts(), msg}); if(S.log.length>100) S.log.pop(); }

// ======== UI æ¸²æŸ“ ========
const TABS = [
  {id:'dash', name:'ä»ªè¡¨ç›˜'},
  {id:'shop', name:'é‡‡è´­'},
  {id:'base', name:'åº‡æŠ¤æ‰€'},
  {id:'inv',  name:'ä»“åº“'}
];
let CUR='dash';

function render(){
  document.getElementById('dayLab').textContent = `Day ${S.day}`;
  document.getElementById('hourLab').textContent = `å½“å‰æ—¶é—´ï¼š${S.hour}:00`;
  document.getElementById('moneyLab').textContent = `$${fmt(S.money)}`;
  document.getElementById('staLab').textContent = `${S.stamina}/100`;
  document.getElementById('staBar').style.width = Math.max(0, S.stamina)+'%';
  document.getElementById('hoursLeftLab').textContent = `${S.hoursLeft}h`;
  document.getElementById('moneyBar').style.width = Math.min(100, (S.money/30000)*100)+'%';
  document.getElementById('allowOver').checked = S.allowOver;
  document.getElementById('allowOver').onchange = (e)=>{ S.allowOver = e.target.checked; save(); };

  // tabs
  const tabs = document.getElementById('tabs');
  tabs.innerHTML = '';
  TABS.forEach(t=>{
    const b = document.createElement('div');
    b.className = 'tab'+(CUR===t.id?' active':'');
    b.textContent = t.name; b.onclick=()=>{ CUR=t.id; renderPanel(); };
    tabs.appendChild(b);
  });
  renderPanel();
}

function needHours(h){
  if(S.hoursLeft>=h){ S.hoursLeft -= h; return true; }
  if(S.allowOver){ // é€æ”¯ï¼šä»ä»Šæ™šç¡çœ æ‰£
    const deficit = h - S.hoursLeft; S.hoursLeft = 0; addLog(`é€æ”¯ ${deficit} å°æ—¶ï¼Œå°†ä»ä»Šæ™šç¡çœ æ‰£é™¤ã€‚`); return true;
  }
  alert('ä»Šå¤©å·¥æ—¶ä¸è¶³ï¼ˆå¯å‹¾é€‰å…è®¸é€æ”¯ï¼‰'); return false;
}

// ======== å„é¢æ¿ ========
function renderPanel(){
  const box = document.getElementById('panel');
  if(CUR==='dash') return renderDash(box);
  if(CUR==='shop') return renderShop(box);
  if(CUR==='base') return renderBase(box);
  if(CUR==='inv')  return renderInv(box);
}

function renderDash(box){
  box.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3 style="color:${S.day>=0?'#ff6b6b':'#14e099'}">${S.day>=0?'å¤–ç•Œå®å†µ':'å‡†å¤‡é˜¶æ®µ'}</h3>
        <div class="muted">â€¢ å¤šåœ°çˆ†å‘æŠ¢è´­å†²çª Â· ç”µç½‘è¶…è´Ÿè· Â· ä»å¯å¤–å‡ºï¼ˆDay 0 å‰æ›´å®‰å…¨ï¼‰</div>
        <div class="row" style="margin-top:10px;gap:8px">
          <button class="btn ghost" onclick="nextHour()">æ—¶é—´ +1h</button>
          <button class="btn primary" onclick="endDay()">ç»“æŸå½“å¤©</button>
          <button class="btn" onclick="resetGame()">é‡å¼€</button>
        </div>
        <div class="notice" style="margin-top:12px">æç¤ºï¼šå»å•†åº—=3hï¼Œè£…æ»¡è½¦å¦åŠ  1~2hï¼Œå›å®¶å¸è´§=2hï¼›å®‰è£…å¤ªé˜³èƒ½/å‡€æ°´ç­‰åœ¨â€œåº‡æŠ¤æ‰€â€ã€‚å…è®¸é€æ”¯å¯ç”¨ä»Šæ™šç¡çœ æŠµæ‰£ã€‚</div>
      </div>

      <div class="card">
        <h3>ä»Šæ—¥æ—¥å¿—</h3>
        <div id="log"></div>
      </div>
    </div>
  `;
  const log = document.getElementById('log');
  log.innerHTML = S.log.map(e=>`<div class="tile"><b>${e.t}</b> â€” ${e.msg}</div>`).join('');
}

function renderShop(box){
  // åº—é€‰æ‹© + è´­ç‰©æ¸…å•
  let shopId = 'costco';
  box.innerHTML = `
    <div class="card">
      <div class="row"><h3>ğŸ›’ é€‰æ‹©å•†åº—</h3>
        <select id="shopSel"></select>
        <button class="btn ghost small" id="goBtn">å‡ºå‘ï¼ˆ3hï¼‰</button>
      </div>
      <div class="muted">è£…æ»¡è½¦å°†é¢å¤– +1~2hï¼Œå›å®¶å¸è´§ +2hã€‚</div>
    </div>
    <div class="card" id="shopPanel" style="display:none"></div>
  `;
  const sel = document.getElementById('shopSel');
  sel.innerHTML = Object.entries(SHOPS).map(([k,v])=>`<option value="${k}">${v.name}</option>`).join('');
  sel.onchange = ()=>{ shopId = sel.value; };
  document.getElementById('goBtn').onclick = ()=>{
    const shop = SHOPS[shopId];
    if(!needHours(shop.travelH)) return; S.hour += shop.travelH; addLog(`å‰å¾€ ${shop.name}ï¼ˆ${shop.travelH}hï¼‰`);
    renderShopInner(shopId);
  };
}

function renderShopInner(shopId){
  const wrap = document.getElementById('shopPanel'); wrap.style.display='block';
  const shop = SHOPS[shopId];
  const rows = shop.items.map(it=>{
    return `<tr>
      <td>${it.name}<div class="muted">$${it.price}/${it.unit} Â· å æ ¼ ${it.slot}</div></td>
      <td class="right"><input type="number" min="0" value="0" data-id="${it.id}" class="qty"></td>
    </tr>`;
  }).join('');
  wrap.innerHTML = `
    <h3>${shop.name}</h3>
    <table><tbody>${rows}</tbody></table>
    <div class="row" style="justify-content:space-between">
      <div>æœ¬æ¬¡é¢„è®¡ï¼š<span id="est"></span></div>
      <div class="row">
        <button class="btn ghost small" id="calcBtn">é‡æ–°ä¼°ç®—</button>
        <button class="btn primary" id="buyBtn">ç»“ç®—å¹¶è¿”å›ï¼ˆå«å¸è´§ï¼‰</button>
      </div>
    </div>
  `;

  const est = ()=>{
    const qtys = collectQty();
    let price=0, slots=0, meals=0, water=0;
    shop.items.forEach(it=>{
      const q = qtys[it.id]||0; price += q*it.price; slots += q*it.slot;
      const eff = ITEM_EFFECTS[it.id]||{}; meals += (eff.meals||0)*q; water += (eff.waterL||0)*q;
    });
    const extraH = slots>=75?2: (slots>=30?1:0);
    const totalH = extraH + shop.unloadH;
    document.getElementById('est').textContent = `èŠ±è´¹ $${fmt(price)} Â· å æ ¼ ${slots} Â· é¢å¤–æ—¶é—´ +${extraH}hï¼ˆè£…è½¦ï¼‰ +${shop.unloadH}hï¼ˆå¸è´§ï¼‰ Â· é¤æ•° +${meals} Â· æ°´ +${water}L`;
    return {price, slots, meals, water, extraH, totalH};
  };
  const collectQty = ()=>{
    const o={}; wrap.querySelectorAll('.qty').forEach(i=>{ o[i.dataset.id]=Number(i.value||0); }); return o;
  };
  document.getElementById('calcBtn').onclick = est;
  document.getElementById('buyBtn').onclick = ()=>{
    const r = est();
    const needH = r.extraH + shop.unloadH; // è£…è½¦+å¸è´§ï¼ˆå¾€è¿”å·²åœ¨å‡ºå‘æ—¶æ‰£ï¼‰
    if(S.money < r.price) return alert('èµ„é‡‘ä¸è¶³');
    if(S.usedSlots + r.slots > S.storeCap) return alert('ä»“åº“å®¹é‡ä¸è¶³');
    if(!needHours(needH)) return;
    S.money -= r.price; S.usedSlots += r.slots; S.meals += r.meals; S.waterL += r.water; S.hour += needH;

    // å†™å…¥æ˜ç»†åˆ°åº“å­˜
    const qtys = collectQty();
    Object.entries(qtys).forEach(([id,q])=>{ if(!q) return; S.inventory[id]=(S.inventory[id]||0)+q; });
    addLog(`åœ¨ ${shop.name} é‡‡è´­ï¼š$${fmt(r.price)}ï¼Œå æ ¼ +${r.slots}ï¼Œé¤æ•° +${r.meals}ï¼Œæ°´ +${r.water}Lã€‚`);
    save(); CUR='dash'; render();
  };
  est();
}

function renderBase(box){
  box.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>ğŸ  åº‡æŠ¤æ‰€å®‰è£…/åŠ å›º</h3>
        <div class="col">
          ${buildRow('å®‰è£…å¤ªé˜³èƒ½(2h)','solar','solar',2)}
          ${buildRow('å®‰è£…å‚¨èƒ½ç”µæ± (0h)','battery','battery',0)}
          ${buildRow('å®‰è£…å‘ç”µæœº(2h)','gen','gen',2)}
          ${buildRow('å®‰è£…å‡€æ°´æœº(3h)','filter','filter',3)}
          ${buildRow('æ¶è®¾é›¨æ°´æ¡¶(2h)','rain','rain',2)}
          ${consRow('å°çª—ç”¨æœ¨æ¿ 1h/å—','board',1)}
          ${consRow('å›´æ é“ä¸ç½‘ 2h/å·','wire',2)}
        </div>
      </div>

      <div class="card">
        <h3>å½“å‰çŠ¶æ€</h3>
        <div>å¤ªé˜³èƒ½ï¼š${S.solar?'<span class=pill ok>å·²å®‰è£…</span>':'æœªè£…'}</div>
        <div>å‚¨èƒ½ç”µæ± ï¼š${S.battery?'<span class=pill ok>å·²å°±ä½</span>':'æœªè£…'}</div>
        <div>å‘ç”µæœºï¼š${S.gen?'<span class=pill warn>å¤‡ç”¨</span>':'æœªè£…'}</div>
        <div>å‡€æ°´ï¼š${S.filter?'<span class=pill ok>âœ”ï¸</span>':'æœªè£…'}</div>
        <div>é›¨æ°´æ”¶é›†ï¼š${S.rain?'<span class=pill ok>âœ”ï¸</span>':'æœªè£…'}</div>
        <div>æœ¨æ¿ï¼š${S.inventory.board||0} å— Â· å·²å° ${S.boards} å—</div>
        <div>é“ä¸ç½‘ï¼š${S.inventory.wire||0} å· Â· å·²å¸ƒç½® ${S.wires} å·</div>
        <div class="muted" style="margin-top:8px">æç¤ºï¼šå®‰è£…ä¼šæ¶ˆè€—ä»Šå¤©å·¥æ—¶ï¼Œå¯åœ¨é¡¶éƒ¨å‹¾é€‰â€œå…è®¸é€æ”¯â€ç”¨ä»Šæ™šç¡çœ æŠµæ‰£ã€‚</div>
      </div>
    </div>
  `;
}

function buildRow(label, key, needItem, h){
  const has = S[ key ];
  const own = (S.inventory[needItem]||0) > 0;
  const btn = has? '<span class="pill ok">å·²å®Œæˆ</span>' : (own? `<button class=\"btn small\" onclick=\"doBuild('${key}',${h},'${needItem}')\">å®‰è£…ï¼ˆ${h}hï¼‰</button>`: '<span class="pill bad">ç¼ºå°‘ææ–™</span>');
  return `<div class="tile row" style="justify-content:space-between"><div>${label}</div><div>${btn}</div></div>`;
}
function consRow(label, itemId, h){
  const own = S.inventory[itemId]||0;
  const btn = own>0? `<button class=\"btn small\" onclick=\"consumeItem('${itemId}',${h})\">ä½¿ç”¨ 1ï¼ˆ${h}hï¼‰</button>` : '<span class="pill bad">åº“å­˜ä¸è¶³</span>';
  return `<div class="tile row" style="justify-content:space-between"><div>${label}</div><div>${btn}</div></div>`;
}
function doBuild(key, h, itemId){
  if(!needHours(h)) return; S.hour += h; S.inventory[itemId]--; if(S.inventory[itemId]<=0) delete S.inventory[itemId];
  S.usedSlots -= shopItemSlot(itemId); S[key]=true; addLog(`å®Œæˆï¼š${key} å®‰è£…ï¼ˆ${h}hï¼‰`); save(); render();
}
function consumeItem(itemId, h){
  if(!needHours(h)) return; S.hour += h; S.inventory[itemId]--; if(S.inventory[itemId]<=0) delete S.inventory[itemId];
  S.usedSlots -= shopItemSlot(itemId);
  if(itemId==='board') S.boards++; if(itemId==='wire') S.wires++;
  addLog(`ä½¿ç”¨ ${itemId} 1 ä¸ªï¼ˆ${h}hï¼‰`); save(); render();
}
function shopItemSlot(id){
  for(const k in SHOPS){ const f = SHOPS[k].items.find(x=>x.id===id); if(f) return f.slot; }
  return 0;
}

function renderInv(box){
  const invRows = Object.entries(S.inventory).sort().map(([id,q])=>{
    const item = findItem(id);
    return `<tr><td>${item?item.name:id}</td><td>${q} ${item?item.unit:''}</td></tr>`;
  }).join('');
  box.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>ğŸ“¦ ä»“åº“æ€»è§ˆ</h3>
        <div class="row">
          <div class="pill ${S.usedSlots>=S.storeCap? 'bad' : ( (S.storeCap-S.usedSlots)/S.storeCap<=0.1? 'warn':'ok')}">å·²ç”¨ ${S.usedSlots}/${S.storeCap} æ ¼</div>
          <div class="pill">é¤æ•°å¯ç”¨ï¼š${S.meals}</div>
          <div class="pill">é¥®æ°´ï¼š${S.waterL} L</div>
        </div>
      </div>
      <div class="card"><h3>æ¸…å•</h3><table><tbody>${invRows||'<tr><td>æš‚æ— ç‰©èµ„</td><td></td></tr>'}</tbody></table></div>
    </div>
  `;
}
function findItem(id){ for(const k in SHOPS){ const f = SHOPS[k].items.find(x=>x.id===id); if(f) return f; } return null; }

// ======== æ—¥æœŸ/ç»“ç®— ========
function nextHour(){ if(!needHours(1)) return; S.hour++; save(); render(); }

function endDay(){
  // ç¡çœ ä¸é€æ”¯ç»“ç®—ï¼šåŸºç¡€ç¡çœ  8hï¼Œè‹¥é€æ”¯ X å°æ—¶ï¼Œåˆ™ç¡çœ  = 8 - Xï¼Œä½“åŠ›å›å¤é™ä½
  const overtime = Math.max(0, 12 - S.hoursLeft); // ä»Šå¤©å¤šå¹²çš„
  const sleepH = Math.max(0, 8 - overtime);
  const staGain = sleepH>=8? 50 : sleepH>=4? 25 : 10;
  S.stamina = Math.min(100, S.stamina + staGain);

  // æ¯æ—¥è‡ªç„¶æ¶ˆè€—
  const needMeals = 2; const needWater = 3; // 2é¤, 3L æ°´
  if(S.meals>=needMeals){ S.meals -= needMeals; } else { S.stamina -= 10; addLog('é¥¥é¥¿å½±å“ä½“åŠ› -10'); }
  if(S.waterL>=needWater){ S.waterL -= needWater; } else { S.stamina -= 20; addLog('ç¼ºæ°´å½±å“ä½“åŠ› -20'); }

  // è¿›æ—¥
  S.day += 1; S.hour = 8; S.hoursLeft = 12; S.allowOver=false;
  addLog(`è¿›å…¥ Day ${S.day}ã€‚ç¡çœ  ${sleepH} å°æ—¶ï¼Œä½“åŠ› +${staGain}ã€‚`);
  if(S.stamina<=0){ alert('ä½“åŠ›è€—å°½ï¼Œæ¸¸æˆç»“æŸ'); resetGame(); return; }
  save(); render();
}

function resetGame(){ if(!confirm('é‡å¼€ï¼Ÿå½“å‰è¿›åº¦ä¼šè¢«æ¸…ç©º')) return; S = initState(); save(); render(); }

// ======== å¯åŠ¨ ========
render();
</script>
</body>
</html>
