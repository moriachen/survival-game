<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æœ«æ—¥å›¤è´§ç”Ÿå­˜ Â· ç½‘é¡µç‰ˆï¼ˆè¿›é˜¶ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#10161c; --card:#131b23; --line:#232e3a; --text:#f5f7fa; --muted:#9fb0c2;
      --accent:#ff4d4f; --ok:#14e099; --warn:#ffcc4d; --vio:#6c5ce7;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e1420);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial;}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{font-size:28px;margin:8px 0 12px 0}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .tile{background:#0f1622;border:1px solid var(--line);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}
    .btn{background:#1f2937;color:#fff;border:1px solid #0000;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent)}
    .btn.good{background:var(--ok);color:#072}
    .btn.ghost{background:transparent;border:1px solid var(--line)}
    .btn.small{padding:6px 10px;border-radius:10px}
    .stat{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    .kpi{min-width:160px;background:#0f1622;border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi .lab{font-size:12px;color:var(--muted)}
    .kpi .num{font-size:22px;font-weight:800}
    .bar{height:8px;background:#0d121a;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,#ff4d4f,#ff7a45)}
    .pill{padding:4px 10px;border-radius:999px;font-size:12px}
    .pill.ok{background:rgba(20,224,153,.18);color:var(--ok)}
    .pill.warn{background:rgba(255,204,77,.2);color:var(--warn)}
    .pill.bad{background:rgba(255,77,79,.2);color:#ff6b6b}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tab{padding:10px 14px;border:1px solid var(--line);border-radius:12px;cursor:pointer}
    .tab.active{background:var(--accent);border-color:transparent}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:10px 12px}
    tbody tr{background:#0f1622;border:1px solid var(--line)}
    tbody tr td:first-child{border-radius:10px 0 0 10px}
    tbody tr td:last-child{border-radius:0 10px 10px 0}
    input[type=number]{width:90px;background:#0d1620;border:1px solid var(--line);color:#fff;border-radius:10px;padding:8px}
    .right{text-align:right}

    .footer{opacity:.6;text-align:center;margin:18px 0 8px}
    .notice{border-left:4px solid var(--accent);padding-left:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ§Ÿâ€â™‚ï¸ æœ«æ—¥å›¤è´§ç”Ÿå­˜ Â· ç½‘é¡µç‰ˆï¼ˆè¿›é˜¶ç‰ˆï¼‰</h1>
  <div class="muted">å•æ–‡ä»¶ Â· æœ¬åœ°å­˜æ¡£ Â· è§„åˆ™é©±åŠ¨ï¼ˆæ— åç«¯ï¼‰</div>

  <!-- é¡¶éƒ¨ KPI -->
  <div class="stat" id="kpi">
    <div class="kpi"><div class="lab">æ—¥æœŸ</div><div class="num" id="dayLab"></div><div class="muted" id="hourLab"></div></div>
    <div class="kpi"><div class="lab">èµ„é‡‘ï¼ˆ$ï¼‰</div><div class="num" id="moneyLab"></div><div class="bar"><i id="moneyBar" style="width:50%"></i></div></div>
    <div class="kpi"><div class="lab">ä½“åŠ›</div><div class="num" id="staLab"></div><div class="bar"><i id="staBar" style="width:80%"></i></div></div>
    <div class="kpi"><div class="lab">ä»Šæ—¥å‰©ä½™å·¥æ—¶</div><div class="num" id="hoursLeftLab"></div><div class="muted">å…è®¸é€æ”¯ <input type="checkbox" id="allowOver"></div></div>
    <div class="kpi"><div class="lab">ä»“åº“å®¹é‡</div><div class="num" id="capLab"></div><div class="muted" id="capSub"></div></div>
    <div class="kpi"><div class="lab">é£é™©/ç”µåŠ›</div><div class="num" id="riskLab"></div><div class="muted" id="powerLab"></div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs" id="tabs"></div>

  <!-- Panels -->
  <div id="panel"></div>

  <div class="footer">Â© Survival Web Demo Â· å»ºè®®éƒ¨ç½² GitHub Pages</div>
</div>

<script>
const LS_KEY = 'survival_web_v3';

// ======== ç‰©èµ„ä¸å•†åº—å®šä¹‰ï¼ˆæ–°å¢ æ­¦å™¨åº—ã€æ¸”å…·ã€å†°æŸœ ç­‰ï¼‰ ========
const SHOPS = {
  costco: { name:'Costco é£Ÿå“/ç”Ÿæ´»', travelH:3, unloadH:2, items:[
    {id:'rice50', name:'å¤§ç±³ 50lb', price:35, unit:'è¢‹', slot:10, meals:240},
    {id:'pasta6', name:'æ„é¢ 6lb ç®±', price:10, unit:'ç®±', slot:3, meals:30},
    {id:'canned', name:'ç½å¤´ 12ç½', price:12, unit:'ç®±', slot:5, meals:24},
    {id:'bars', name:'èƒ½é‡æ£’ 30æ¡', price:18, unit:'ç›’', slot:3, meals:30},
    {id:'water24', name:'ç“¶è£…æ°´ 24Ã—500ml', price:4, unit:'ç®±', slot:2, waterL:12},
    {id:'oil5l', name:'é£Ÿç”¨æ²¹ 5L', price:12, unit:'æ¡¶', slot:3},
    {id:'milkpow', name:'å¥¶ç²‰ 2.5kg', price:25, unit:'ç½', slot:4, meals:25},
    {id:'eggs60', name:'é¸¡è›‹ 60æš', price:12, unit:'ç›’', slot:4, meals:20, needCold:true},
    {id:'cheese2k', name:'å¥¶é…ª 2kg', price:20, unit:'å—', slot:5, meals:20, needCold:true}
  ]},
  walmart: { name:'Walmart ç»¼åˆè¶…å¸‚', travelH:3, unloadH:2, items:[
    {id:'flour25', name:'é¢ç²‰ 25lb', price:18, unit:'è¢‹', slot:5, meals:60},
    {id:'salt', name:'é£Ÿç› 50åŒ…', price:6, unit:'ç®±', slot:2},
    {id:'sugar', name:'ç™½ç³– 10lb', price:8, unit:'è¢‹', slot:3},
    {id:'freezer_meat', name:'å†·å†»è‚‰ 10lb', price:25, unit:'åŒ…', slot:6, meals:25, needCold:true},
    {id:'fishing_rod', name:'é’“é±¼ç«¿', price:20, unit:'æ ¹', slot:2}
  ]},
  cvs: { name:'CVS è¯å“', travelH:3, unloadH:1, items:[
    {id:'pain', name:'æ­¢ç—›è¯', price:10, unit:'ç“¶', slot:1},
    {id:'vit', name:'ç»´ç”Ÿç´ ', price:15, unit:'ç“¶', slot:1},
    {id:'alcohol', name:'æ¶ˆæ¯’æ¶² 1L', price:8, unit:'ç“¶', slot:1},
    {id:'mask', name:'å£ç½© 50åª', price:20, unit:'ç›’', slot:2},
    {id:'cold', name:'æ„Ÿå†’è¯', price:12, unit:'ç›’', slot:1},
    {id:'antinflam', name:'æ¶ˆç‚è¯(OTC)', price:15, unit:'ç›’', slot:1}
  ]},
  homedepot: { name:'Home Depot è®¾å¤‡/å»ºæ', travelH:3, unloadH:2, items:[
    {id:'solar', name:'å¤ªé˜³èƒ½æ¿ 1kW', price:2000, unit:'å¥—', slot:30, build:'solar', buildH:2},
    {id:'battery', name:'å‚¨èƒ½ç”µæ± (UPS)', price:1000, unit:'å°', slot:20, build:'battery', buildH:0},
    {id:'gen', name:'å‘ç”µæœº(ä¸­å‹)', price:800, unit:'å°', slot:20, build:'gen', buildH:2},
    {id:'filter', name:'å®¶ç”¨å‡€æ°´æœº', price:200, unit:'å°', slot:10, build:'filter', buildH:3},
    {id:'rain', name:'é›¨æ°´æ”¶é›†æ¡¶ 50gal', price:250, unit:'åª', slot:20, build:'rain', buildH:2},
    {id:'freezer_ap', name:'ç«‹å¼å†°æŸœ', price:300, unit:'å°', slot:20, build:'freezer', buildH:1},
    {id:'board', name:'æœ¨æ¿', price:3, unit:'å—', slot:1, build:'board'},
    {id:'wire', name:'é“ä¸ç½‘å·', price:40, unit:'å·', slot:5, build:'wire'},
    {id:'tools', name:'å·¥å…·å¥—è£…', price:40, unit:'å¥—', slot:5}
  ]},
  bookstore: { name:'ä¹¦åº— æŠ€èƒ½ä¹¦ç±', travelH:2, unloadH:0, items:[
    {id:'book_garden', name:'ã€Šå®¶åº­å›­è‰ºå…¥é—¨ã€‹', price:25, unit:'æœ¬', slot:1},
    {id:'book_gen', name:'ã€Šå‘ç”µæœºç»´æŠ¤ã€‹', price:30, unit:'æœ¬', slot:1},
    {id:'book_firstaid', name:'ã€Šæ€¥æ•‘æ‰‹å†Œã€‹', price:30, unit:'æœ¬', slot:1}
  ]},
  gas: { name:'åŠ æ²¹ç«™', travelH:2, unloadH:0, items:[
    {id:'gas5', name:'æ±½æ²¹ 5galï¼ˆéœ€æ²¹æ¡¶ï¼‰', price:18, unit:'æ¡¶', slot:5}
  ]},
  market: { name:'å†œè´¸å¸‚åœº/ç§å­', travelH:2, unloadH:1, items:[
    {id:'seeds', name:'è”¬èœç§å­ç»„åˆ', price:20, unit:'å¥—', slot:1},
    {id:'fert', name:'æœ‰æœºè‚¥ 10lb', price:15, unit:'è¢‹', slot:3}
  ]},
  weapon: { name:'æˆ·å¤–/æ­¦å™¨åº—ï¼ˆæ¸¸æˆå†…è™šæ„ï¼‰', travelH:3, unloadH:1, items:[
    {id:'melee_bat', name:'é˜²èº«æ£’', price:25, unit:'æ ¹', slot:3},
    {id:'handgun', name:'æ‰‹æªï¼ˆéœ€åˆæ³•è®¸å¯ï¼‰', price:400, unit:'æŠŠ', slot:10},
    {id:'rifle', name:'æ­¥æªï¼ˆéœ€åˆæ³•è®¸å¯ï¼‰', price:800, unit:'æŠŠ', slot:15},
    {id:'ammo9', name:'9mm å¼¹è¯ Ã—50', price:30, unit:'ç›’', slot:2},
    {id:'ammo556', name:'5.56 å¼¹è¯ Ã—60', price:45, unit:'ç›’', slot:3}
  ]}
};

// ç‰©èµ„è½¬åŒ–
const ITEM_EFFECTS = {
  rice50:{ meals:240 }, pasta6:{meals:30}, canned:{meals:24}, bars:{meals:30}, milkpow:{meals:25},
  eggs60:{meals:20, perishable:true}, cheese2k:{meals:20, perishable:true},
  water24:{waterL:12}, freezer_meat:{meals:25, perishable:true}
};


// å¤–ç•Œå®å†µï¼ˆæ¯æ—¥æ›´æ–°éšæœºï¼‰
const WORLD_NEWS = [
  'å¤šåœ°æŠ¢è´­å‡çº§ï¼Œè­¦æ–¹å»ºè®®å‡å°‘å‡ºè¡Œã€‚',
  'ç”µç½‘è´Ÿè·æ¥è¿‘æé™ï¼Œæˆ–å°†åˆ†åŒºé™ç”µã€‚',
  'åŒ»é™¢æ€¥è¯Šçˆ†æ»¡ï¼Œå¸¸è§„è¯å“çŸ­ç¼ºã€‚',
  'åŠ æ²¹ç«™æ’é˜Ÿæ˜æ˜¾å¢åŠ ã€‚',
  'å±€éƒ¨éªšä¹±è§†é¢‘æµä¼ ï¼Œå»ºè®®é¿å¼€äººç¾¤ã€‚'
];

// éšæœºäº‹ä»¶ï¼ˆæŒ‰é£é™©è§¦å‘ï¼‰
const EVENTS = [
  {id:'theft', minRisk:40, text:'å¤œé—´æœ‰å¯ç–‘äººå‘˜å¾˜å¾Šï¼ŒæŸå¤±å°‘é‡ç‰©èµ„ã€‚', effect:s=>{ const k=Object.keys(s.inventory)[0]; if(k){ s.inventory[k]--; if(s.inventory[k]<=0) delete s.inventory[k]; s.usedSlots = Math.max(0, s.usedSlots-1); }}},
  {id:'car_issue', minRisk:30, text:'è½¦è¾†å°æ•…éšœï¼Œä¿®ç†èŠ±è´¹ $30ã€‚', effect:s=>{ s.money=Math.max(0,s.money-30); }},
  {id:'neighbour_help', minRisk:0, text:'é‚»å±…äº’åŠ©ï¼Œèµ ä¸ä½  1 é¤é£Ÿç‰©ã€‚', effect:s=>{ s.meals+=1; }}
];

// ======== åˆå§‹çŠ¶æ€ ========
function initState(){
  return {
    // æ—¶é—´/è¡ŒåŠ¨
    day:-3, hour:8, hoursLeft:12,
    // èµ„æº
    money:30000, stamina:100, mood:70,
    allowOver:false,
    // åº‡æŠ¤æ‰€
    baseType:null, // 'suburb' | 'lake'
    storeCap:500, usedSlots:0,
    // è®¾å¤‡
    solar:false, battery:false, gen:false, filter:false, rain:false, freezer:false,
    // åº“å­˜/é¤æ°´
    inventory:{}, meals:0, waterL:0,
    // å†·é“¾å‰©ä½™å¤©æ•°ï¼ˆæ— ç”µåŠ›ä¼šä¸‹é™ï¼‰
    coldDays:0,
    // é£é™©ä¸ç”µåŠ›
    risk:10, gridOn:true,
    // ç§ç”°/é’“é±¼
    garden:{plots:0, skill:false, progress:0},
    // æ­¦å™¨ä¸å¼¹è¯
    wep:{melee:false, handgun:false, rifle:false, ammo9:0, ammo556:0},

    news: 'åŸå¸‚æš‚æ—¶å¹³é™ï¼Œåªæœ‰å°‘æ•°äººå¯Ÿè§‰åˆ°å¼‚å¸¸ã€‚',
    log:[{t:ts(), msg:'æ¸¸æˆå¼€å§‹ã€‚ä½ æå‰ 3 å¤©è·æ‚‰ç–«æƒ…ï¼Œå°†åœ¨ 2 å¤©å†…å®Œæˆå›¤è´§ä¸åŠ å›ºã€‚'}]
  }
}

let S = JSON.parse(localStorage.getItem(LS_KEY)) || initState();

// ======== å·¥å…· ========
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(S)); }
function ts(){ return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
function fmt(n){ return (n||0).toLocaleString(); }
function addLog(msg){ S.log.unshift({t:ts(), msg}); if(S.log.length>120) S.log.pop(); }
function hourMod(){ return ((S.hour%24)+24)%24; }
function curDayAdj(){ return S.day + Math.floor(S.hour/24); }
function powerAvailable(){ return S.gridOn || S.solar || S.gen || S.battery; }
function showTime(){ const h = hourMod().toString().padStart(2,'0'); return `Day ${curDayAdj()}  ${h}:00`; }
function spendStamina(h){ const loss = Math.ceil(h*4); S.stamina = Math.max(0, S.stamina - loss); }
function needHours(h, riskDelta=0){
  if(S.hoursLeft>=h){ S.hoursLeft -= h; } else if(S.allowOver){ const deficit=h-S.hoursLeft; S.hoursLeft=0; addLog(`é€æ”¯ ${deficit} å°æ—¶ï¼Œå°†ä»ç¡çœ æ‰£é™¤ã€‚`);} else { alert('ä»Šå¤©å·¥æ—¶ä¸è¶³ï¼ˆå¯å‹¾é€‰å…è®¸é€æ”¯ï¼‰'); return false; }
  S.hour += h; spendStamina(h); S.risk = Math.min(100, Math.max(0, S.risk + riskDelta)); return true;
}

// ======== UI ========
const TABS = [
  {id:'dash', name:'ä»ªè¡¨ç›˜'},
  {id:'shop', name:'é‡‡è´­'},
  {id:'base', name:'åº‡æŠ¤æ‰€'},
  {id:'actions', name:'æ´»åŠ¨'},
  {id:'inv',  name:'ä»“åº“'}
];
let CUR='dash';

function render(){
  document.getElementById('dayLab').textContent = `Day ${curDayAdj()}`;
  document.getElementById('hourLab').textContent = `å½“å‰æ—¶é—´ï¼š${hourMod().toString().padStart(2,'0')}:00`;
  document.getElementById('moneyLab').textContent = `$${fmt(S.money)}`;
  document.getElementById('staLab').textContent = `${S.stamina}/100`;
  document.getElementById('staBar').style.width = Math.max(0, S.stamina)+'%';
  document.getElementById('hoursLeftLab').textContent = `${S.hoursLeft}h`;
  document.getElementById('moneyBar').style.width = Math.min(100, (S.money/30000)*100)+'%';
  document.getElementById('allowOver').checked = S.allowOver;
  document.getElementById('allowOver').onchange = (e)=>{ S.allowOver = e.target.checked; save(); };
  document.getElementById('capLab').textContent = `${S.usedSlots}/${S.storeCap}`;
  document.getElementById('capSub').textContent = `å‰©ä½™ ${S.storeCap - S.usedSlots} æ ¼`;
  document.getElementById('riskLab').textContent = `é£é™© ${S.risk}/100`;
  document.getElementById('powerLab').textContent = powerAvailable()? 'ç”µåŠ›ï¼šå¯ç”¨' : 'ç”µåŠ›ï¼šä¸­æ–­';

  const tabs = document.getElementById('tabs'); tabs.innerHTML='';
  TABS.forEach(t=>{ const b=document.createElement('div'); b.className='tab'+(CUR===t.id?' active':''); b.textContent=t.name; b.onclick=()=>{ CUR=t.id; renderPanel(); }; tabs.appendChild(b); });
  renderPanel();
}

function renderPanel(){
  const box = document.getElementById('panel');
  if(CUR==='dash') return renderDash(box);
  if(CUR==='shop') return renderShop(box);
  if(CUR==='base') return renderBase(box);
  if(CUR==='actions') return renderActions(box);
  if(CUR==='inv')  return renderInv(box);
}

function renderDash(box){
  const baseInfo = S.baseType? (S.baseType==='suburb'?'éƒŠå¤– houseï¼ˆè€•ç§/æ‰“çŒåŠ æˆï¼Œæ¯æ—¥ +1 é¤ï¼‰':'æ¹–è¾¹ houseï¼ˆå¯å–æ°´/é’“é±¼ï¼Œæ¯æ—¥ +2L æ°´ï¼‰') : 'æœªé€‰æ‹©åº‡æŠ¤æ‰€';
  box.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3 style="color:${curDayAdj()>=0?'#ff6b6b':'#14e099'}">å¤–ç•Œå®å†µï¼ˆæ¯æ—¥åˆ·æ–°ï¼‰</h3>
        <div class="muted">${S.news}</div>
        <div class="row" style="margin-top:10px;gap:8px">
          <button class="btn ghost" onclick="advanceHour()">æ—¶é—´ +1h</button>
          <button class="btn primary" onclick="sleepNow()">ç¡è§‰ï¼ˆç»“ç®—å½“æ—¥ï¼‰</button>
          <button class="btn" onclick="resetGame()">é‡å¼€</button>
        </div>
        <div class="notice" style="margin-top:12px">æç¤ºï¼šå‡ºè¡Œä¼šæé«˜é£é™©ï¼›ä½“åŠ›éšå·¥æ—¶ä¸‹é™ã€‚</div>
      </div>

      <div class="card">
        <h3>åº‡æŠ¤æ‰€</h3>
        <div>å½“å‰ï¼š${baseInfo}</div>
        ${!S.baseType? `<div class="row" style="margin-top:10px">
          <button class="btn small" onclick="chooseBase('suburb')">é€‰æ‹©éƒŠå¤– Houseï¼ˆå®¹é‡ +100ï¼‰</button>
          <button class="btn small" onclick="chooseBase('lake')">é€‰æ‹©æ¹–è¾¹ Houseï¼ˆæ¯æ—¥ +2L æ°´ï¼‰</button>
        </div>`:''}
        <h3 style="margin-top:12px">ä»Šæ—¥æ—¥å¿—</h3>
        <div id="log"></div>
      </div>
    </div>
  `;
  const log = document.getElementById('log');
  log.innerHTML = S.log.map(e=>`<div class="tile"><b>${e.t}</b> â€” ${e.msg}</div>`).join('');
}

function chooseBase(t){ if(S.baseType) return; S.baseType=t; if(t==='suburb'){ S.storeCap+=100; addLog('é€‰æ‹©éƒŠå¤– houseï¼šä»“åº“å®¹é‡ +100ã€‚'); } if(t==='lake'){ addLog('é€‰æ‹©æ¹–è¾¹ houseï¼šæ¯æ—¥é¢å¤– +2L æ°´ã€‚'); } save(); render(); }
function advanceHour(){ if(!needHours(1)) return; save(); render(); }

// ======== é‡‡è´­ï¼ˆåŠ å…¥è½¦è¾†å®¹é‡/å¤šè¶Ÿæ¬¡æ•°ï¼‰ ========
const CAR_CAP = 120; // æ¯è¶Ÿå¯è£…çš„â€œæ ¼â€
function renderShop(box){
  let shopId = 'costco';
  box.innerHTML = `
    <div class="card">
      <div class="row"><h3>ğŸ›’ é€‰æ‹©å•†åº—</h3>
        <select id="shopSel"></select>
        <button class="btn ghost small" id="goBtn">å‡ºå‘ï¼ˆ3hï¼‰</button>
      </div>
      <div class="muted">è½¦è¾†å®¹é‡ï¼šæ¯è¶Ÿ ${CAR_CAP} æ ¼ï¼›è‹¥è¶…å‡ºå°†è‡ªåŠ¨å¤šè¶Ÿå¾€è¿”ã€‚</div>
    </div>
    <div class="card" id="shopPanel" style="display:none"></div>
  `;
  const sel = document.getElementById('shopSel'); sel.innerHTML = Object.entries(SHOPS).map(([k,v])=>`<option value="${k}">${v.name}</option>`).join(''); sel.onchange=()=>{ shopId=sel.value };
  document.getElementById('goBtn').onclick = ()=>{
    const shop = SHOPS[shopId]; if(!needHours(shop.travelH, +5)) return; addLog(`å‰å¾€ ${shop.name}ï¼ˆ${shop.travelH}hï¼‰`); renderShopInner(shopId);
  };
}

function renderShopInner(shopId){
  const wrap = document.getElementById('shopPanel'); wrap.style.display='block'; const shop = SHOPS[shopId];
  const rows = shop.items.map(it=>`<tr><td>${it.name}<div class="muted">$${it.price}/${it.unit} Â· å æ ¼ ${it.slot}${it.needCold?' Â· éœ€å†·è—':''}</div></td><td class="right"><input type="number" min="0" value="0" data-id="${it.id}" class="qty"></td></tr>`).join('');
  wrap.innerHTML = `
    <h3>${shop.name}</h3>
    <table><tbody>${rows}</tbody></table>
    <div class="row" style="justify-content:space-between">
      <div>æœ¬æ¬¡é¢„è®¡ï¼š<span id="est"></span></div>
      <div class="row"><button class="btn ghost small" id="calcBtn">é‡æ–°ä¼°ç®—</button><button class="btn primary" id="buyBtn">ç»“ç®—å¹¶è¿”å›ï¼ˆå«å¸è´§ï¼‰</button></div>
    </div>`;

  const collectQty = ()=>{ const o={}; wrap.querySelectorAll('.qty').forEach(i=>{ o[i.dataset.id]=Number(i.value||0); }); return o; };
  const est = ()=>{
    const qtys = collectQty(); let price=0, slots=0, meals=0, water=0, cold=0;
    shop.items.forEach(it=>{ const q=qtys[it.id]||0; price+=q*it.price; slots+=q*it.slot; const eff=ITEM_EFFECTS[it.id]||{}; meals+=(eff.meals||0)*q; water+=(eff.waterL||0)*q; if(it.needCold) cold+=q; });
    const trips = Math.max(1, Math.ceil(slots/CAR_CAP));
    const extraH = (trips-1)*(shop.travelH+shop.unloadH) + (slots>=75?2:(slots>=30?1:0));
    document.getElementById('est').textContent = `èŠ±è´¹ $${fmt(price)} Â· å æ ¼ ${slots}ï¼ˆ${trips} è¶Ÿï¼‰ Â· é¢å¤– +${extraH}h Â· é¤æ•° +${meals} Â· æ°´ +${water}L Â· å†·é“¾ä»¶æ•° ${cold}`;
    return {price, slots, meals, water, extraH, trips, cold};
  };
  document.getElementById('calcBtn').onclick = est;
  document.getElementById('buyBtn').onclick = ()=>{
    const r = est(); const needH = r.extraH + shop.unloadH; if(S.money<r.price) return alert('èµ„é‡‘ä¸è¶³'); if(S.usedSlots + r.slots > S.storeCap) return alert('ä»“åº“å®¹é‡ä¸è¶³'); if(!needHours(needH, +5)) return;
    S.money -= r.price; S.usedSlots += r.slots; S.meals += r.meals; S.waterL += r.water; S.coldDays += r.cold>0? 2:0; // æ–°è´­å†·é“¾ç»™ 2 å¤©ç¼“å†²

    // å†™åº“å­˜/æ­¦å™¨/å¼¹è¯æ˜ å°„
    const qtys = collectQty(); Object.entries(qtys).forEach(([id,q])=>{ if(!q) return; S.inventory[id]=(S.inventory[id]||0)+q; if(id==='melee_bat') S.wep.melee=true; if(id==='handgun') S.wep.handgun=true; if(id==='rifle') S.wep.rifle=true; if(id==='ammo9') S.wep.ammo9+=q*50; if(id==='ammo556') S.wep.ammo556+=q*60; });
    addLog(`åœ¨ ${shop.name} é‡‡è´­ï¼š$${fmt(r.price)}ï¼Œå æ ¼ +${r.slots}ï¼ˆ${r.trips} è¶Ÿï¼‰ï¼Œé¤æ•° +${r.meals}ï¼Œæ°´ +${r.water}Lã€‚`);
    save(); CUR='dash'; render();
  };
  est();
}

// ======== åº‡æŠ¤æ‰€ï¼ˆå«è®¾å¤‡å®‰è£…ï¼‰ ========
function renderBase(box){
  box.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>ğŸ  å®‰è£…/åŠ å›º</h3>
        <div class="col">
          ${buildRow('å¤ªé˜³èƒ½(2h)','solar','solar',2)}
          ${buildRow('å‚¨èƒ½ç”µæ± (0h)','battery','battery',0)}
          ${buildRow('å‘ç”µæœº(2h)','gen','gen',2)}
          ${buildRow('å‡€æ°´æœº(3h)','filter','filter',3)}
          ${buildRow('é›¨æ°´æ¡¶(2h)','rain','rain',2)}
          ${buildRow('ç«‹å¼å†°æŸœ(1h)','freezer','freezer_ap',1)}
          ${consRow('å°çª— æœ¨æ¿ 1h/å—','board',1)}
          ${consRow('å›´æ  é“ä¸ç½‘ 2h/å·','wire',2)}
        </div>
      </div>

      <div class="card">
        <h3>å½“å‰çŠ¶æ€</h3>
        <div>åº‡æŠ¤æ‰€ï¼š${S.baseType? (S.baseType==='suburb'?'éƒŠå¤– house':'æ¹–è¾¹ house') : 'æœªé€‰æ‹©'}</div>
        <div>ç”µåŠ›ï¼š${powerAvailable()? '<span class=pill ok>å¯ç”¨</span>':'<span class=pill bad>ä¸­æ–­</span>'}</div>
        <div>å†·é“¾ç¼“å†²ï¼š${S.coldDays} å¤©</div>
        <div>è®¾å¤‡ï¼šå¤ªé˜³èƒ½ ${tick(S.solar)} / ç”µæ±  ${tick(S.battery)} / å‘ç”µæœº ${tick(S.gen)} / å‡€æ°´ ${tick(S.filter)} / é›¨æ°´ ${tick(S.rain)} / å†°æŸœ ${tick(S.freezer)}</div>
        <div>æœ¨æ¿ï¼š${S.inventory.board||0} å— Â· å·²å° ${S.boards||0} å—</div>
        <div>é“ä¸ç½‘ï¼š${S.inventory.wire||0} å· Â· å·²å¸ƒç½® ${S.wires||0} å·</div>
      </div>
    </div>
  `;
}
function tick(b){return b?'âœ”ï¸':'â€”'}
function buildRow(label, key, needItem, h){ const has=S[key]; const own=(S.inventory[needItem]||0)>0; const btn=has? '<span class="pill ok">å·²å®Œæˆ</span>' : (own? `<button class=\"btn small\" onclick=\"doBuild('${key}',${h},'${needItem}')\">å®‰è£…ï¼ˆ${h}hï¼‰</button>`: '<span class="pill bad">ç¼ºå°‘ææ–™</span>'); return `<div class="tile row" style="justify-content:space-between"><div>${label}</div><div>${btn}</div></div>`; }
function consRow(label, itemId, h){ const own=S.inventory[itemId]||0; const btn=own>0? `<button class=\"btn small\" onclick=\"consumeItem('${itemId}',${h})\">ä½¿ç”¨ 1ï¼ˆ${h}hï¼‰</button>`:'<span class="pill bad">åº“å­˜ä¸è¶³</span>'; return `<div class="tile row" style="justify-content:space-between"><div>${label}</div><div>${btn}</div></div>`; }
function doBuild(key,h,itemId){ if(!needHours(h)) return; S.inventory[itemId]--; if(S.inventory[itemId]<=0) delete S.inventory[itemId]; S.usedSlots -= shopItemSlot(itemId); S[key]=true; if(key==='freezer') S.coldDays=5; addLog(`å®Œæˆï¼š${key} å®‰è£…ï¼ˆ${h}hï¼‰`); save(); render(); }
function consumeItem(itemId,h){ if(!needHours(h)) return; S.inventory[itemId]--; if(S.inventory[itemId]<=0) delete S.inventory[itemId]; S.usedSlots -= shopItemSlot(itemId); if(itemId==='board') S.boards=(S.boards||0)+1; if(itemId==='wire') S.wires=(S.wires||0)+1; addLog(`ä½¿ç”¨ ${itemId} 1 ä¸ªï¼ˆ${h}hï¼‰`); save(); render(); }
function shopItemSlot(id){ for(const k in SHOPS){ const f=SHOPS[k].items.find(x=>x.id===id); if(f) return f.slot; } return 0; }

// ======== æ´»åŠ¨ï¼ˆé’“é±¼/ç§ç”°/å­¦ä¹ /ç»ƒä¹ å°„å‡»ï¼‰ ========
function renderActions(box){
  box.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>ğŸ£ é’“é±¼ï¼ˆæ¹–è¾¹ï¼‰</h3>
        <div class="muted">éœ€è¦ï¼šæ¹–è¾¹ house + é’“é±¼ç«¿ï¼›2h â‰ˆ 1~3 é¤ï¼Œå°‘é‡æå‡å¿ƒæƒ…ã€‚</div>
        <button class="btn small" onclick="goFish()">é’“é±¼ 2h</button>
      </div>
      <div class="card">
        <h3>ğŸŒ± ç§ç”°</h3>
        <div>åœ°å—ï¼š${S.garden.plots} Â· è¿›åº¦ï¼š${S.garden.progress}% Â· æŠ€èƒ½ï¼š${S.garden.skill?'å·²å­¦':'æœªå­¦'}</div>
        <div class="row"><button class="btn small" onclick="setupGarden()">å¼€å¦åœ°å—(2h)</button><button class="btn small" onclick="tendGarden()">ç…§æ–™æµ‡çŒ(2h)</button><button class="btn small" onclick="harvest()">æ”¶è·</button></div>
      </div>
      <div class="card">
        <h3>ğŸ“š å­¦ä¹ </h3>
        <div class="muted">é˜…è¯»ã€Šå®¶åº­å›­è‰ºå…¥é—¨ã€‹å¯æå‡ç§ç”°å­˜æ´»ç‡ï¼›2h å­¦ä¹  1 æ¬¡ã€‚</div>
        <button class="btn small" onclick="study('book_garden')">å­¦ä¹ å›­è‰º 2h</button>
      </div>
      <div class="card">
        <h3>ğŸ›¡ï¸ è®­ç»ƒï¼ˆå®‰å…¨ï¼‰</h3>
        <div class="muted">æ•´ç†è£…å¤‡ã€åŠ å›ºé—¨çª—ã€åŸºç¡€ä½“èƒ½ï¼›2hï¼Œé£é™© -5ï¼Œä½“åŠ› -4ã€‚</div>
        <button class="btn small" onclick="train()">è®­ç»ƒ 2h</button>
      </div>
    </div>
  `;
}
function goFish(){ if(S.baseType!=='lake') return alert('éœ€è¦æ¹–è¾¹ house'); if(!(S.inventory.fishing_rod>0)) return alert('ç¼ºå°‘é’“é±¼ç«¿'); if(!needHours(2, +3)) return; const gain=1+Math.floor(Math.random()*3); S.meals+=gain; S.mood=Math.min(100,S.mood+2); addLog(`é’“é±¼æ”¶è· ${gain} é¤ã€‚`); save(); render(); }
function setupGarden(){ if(!(S.inventory.seeds>0)) return alert('ç¼ºå°‘ç§å­'); if(!needHours(2, +2)) return; S.garden.plots+=1; S.inventory.seeds--; S.usedSlots-=shopItemSlot('seeds'); addLog('å¼€å¦ 1 ä¸ªåœ°å—ã€‚'); save(); render(); }
function tendGarden(){ if(S.garden.plots<=0) return alert('æ²¡æœ‰åœ°å—'); if(S.waterL<1) return alert('éœ€è¦è‡³å°‘ 1L æ°´'); if(!needHours(2, +1)) return; const eff = S.garden.skill? 20:10; S.garden.progress=Math.min(100,S.garden.progress+eff); S.waterL-=1; addLog(`ç…§æ–™èœåœ°ï¼Œè¿›åº¦ +${eff}%ã€‚`); save(); render(); }
function harvest(){ if(S.garden.progress<100) return alert('è¿˜æœªæˆç†Ÿ'); const gain= S.garden.plots * (S.garden.skill? 10:7); S.meals+=gain; S.garden.progress=0; addLog(`æ”¶è·è”¬èœï¼š+${gain} é¤ã€‚`); save(); render(); }
function study(bookId){ if(!(S.inventory[bookId]>0)) return alert('ç¼ºå°‘ä¹¦ç±'); if(!needHours(2, 0)) return; if(bookId==='book_garden') { S.garden.skill=true; addLog('å­¦ä¹ å›­è‰ºå®Œæˆï¼Œè€•ä½œæ•ˆç‡æå‡ã€‚'); } save(); render(); }
function train(){ if(!needHours(2, -5)) return; addLog('è®­ç»ƒå®Œæˆï¼šé£é™© -5ã€‚'); save(); render(); }

// ======== ä»“åº“ ========
function renderInv(box){ const invRows = Object.entries(S.inventory).sort().map(([id,q])=>{ const item = findItem(id); return `<tr><td>${item?item.name:id}</td><td>${q} ${item?item.unit:''}</td></tr>`; }).join(''); box.innerHTML = `<div class="grid"><div class="card"><h3>ğŸ“¦ ä»“åº“æ€»è§ˆ</h3><div class="row"><div class="pill ${S.usedSlots>=S.storeCap? 'bad' : ( (S.storeCap-S.usedSlots)/S.storeCap<=0.1? 'warn':'ok')}">å·²ç”¨ ${S.usedSlots}/${S.storeCap} æ ¼</div><div class="pill">é¤æ•°ï¼š${S.meals}</div><div class="pill">é¥®æ°´ï¼š${S.waterL} L</div><div class="pill">å†·é“¾ï¼š${S.coldDays} å¤©</div></div></div><div class="card"><h3>æ¸…å•</h3><table><tbody>${invRows||'<tr><td>æš‚æ— ç‰©èµ„</td><td></td></tr>'}</tbody></table></div></div>`; }
function findItem(id){ for(const k in SHOPS){ const f = SHOPS[k].items.find(x=>x.id===id); if(f) return f; } return null; }

// ======== ç¡è§‰/æ—¥ç»“ï¼šå¤–ç•Œå®å†µã€è¢«åŠ¨äº§å‡ºã€å†·é“¾è…è´¥ã€éšæœºäº‹ä»¶ ========
function sleepNow(){
  const curH = hourMod(); const sleepH = (24 - curH) + 8; const staGain = sleepH>=8? 50 : sleepH>=4? 25 : 10; S.stamina = Math.min(100, S.stamina + staGain);

  // æ¯æ—¥è‡ªç„¶æ¶ˆè€—
  const needMeals = 2; const needWater = 3; if(S.meals>=needMeals){ S.meals -= needMeals; } else { S.stamina -= 10; addLog('é¥¥é¥¿å½±å“ä½“åŠ› -10'); } if(S.waterL>=needWater){ S.waterL -= needWater; } else { S.stamina -= 20; addLog('ç¼ºæ°´å½±å“ä½“åŠ› -20'); }

  // è¢«åŠ¨æ”¶ç›Š
  if(S.baseType==='lake') { S.waterL += 2; addLog('æ¹–è¾¹å–æ°´ï¼š+2L'); }
  if(S.baseType==='suburb') { S.meals += 1; addLog('éƒŠå¤–é‡‡é›†/æ‰“çŒï¼š+1 é¤'); }

  // å†·é“¾ï¼šæœ‰ç”µ/å†°æŸœåˆ™ç»´æŒï¼Œå¦åˆ™è¡°å‡
  if(powerAvailable() && S.freezer){ S.coldDays = Math.min(7, S.coldDays + 1); } else { if(S.coldDays>0) S.coldDays -= 1; }
  if(S.coldDays<=0){ // æ˜“è…ç‰©èµ„æŸè€—
    const spoilKeys = ['eggs60','cheese2k','freezer_meat'];
    spoilKeys.forEach(k=>{ const n=S.inventory[k]||0; if(n>0){ const lost=Math.ceil(n*0.5); S.inventory[k]=Math.max(0,n-lost); if(S.inventory[k]===0) delete S.inventory[k]; addLog(`${findItem(k)?.name||k} å˜è´¨ï¼ŒæŸå¤± ${lost}`); }});
  }

  // éšæœºäº‹ä»¶ï¼šæŒ‰é£é™©æ¦‚ç‡
  const p = Math.min(0.6, S.risk/100); if(Math.random()<p){ const cand = EVENTS.filter(e=>S.risk>=e.minRisk); const ev = cand[Math.floor(Math.random()*cand.length)]; if(ev){ ev.effect(S); addLog(`äº‹ä»¶ï¼š${ev.text}`); if(S.wep.handgun||S.wep.rifle||S.wep.melee) { addLog('ä½ çš„é˜²èº«è£…å¤‡è®©å±€é¢å¯æ§ã€‚'); S.risk=Math.max(0,S.risk-5); } } }

  // è¿›å…¥æ¬¡æ—¥
  S.day = curDayAdj() + 1; S.hour = 8; S.hoursLeft = 12; S.allowOver=false; S.news = WORLD_NEWS[Math.floor(Math.random()*WORLD_NEWS.length)];
  if(S.stamina<=0){ alert('ä½“åŠ›è€—å°½ï¼Œæ¸¸æˆç»“æŸ'); resetGame(); return; }
  save(); render();
}

function resetGame(){ if(!confirm('é‡å¼€ï¼Ÿå½“å‰è¿›åº¦ä¼šè¢«æ¸…ç©º')) return; S = initState(); save(); render(); }

// ======== å…¶å®ƒå°å·¥å…· ========
function shopItemSlot(id){ for(const k in SHOPS){ const f=SHOPS[k].items.find(x=>x.id===id); if(f) return f.slot; } return 0; }

// ======== å¯åŠ¨ ========
render();
</script>
</body>
</html>
